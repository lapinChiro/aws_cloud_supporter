# AWS Cloud Supporter フェーズ2要件定義書

## 1. プロジェクト概要

### 1.1 ビジネス価値とユーザーストーリー

**ユーザーペルソナ**: クラウドインフラエンジニア、DevOpsエンジニア、SRE

**ユーザーストーリー**:
- 「CloudFormationテンプレートを作成したが、どのメトリクスを監視すべきかわからない」
- 「手動でメトリクスを調べるのに時間がかかりすぎる」
- 「チーム内でモニタリング設定の知識が属人化している」
- 「新しいAWSサービスのメトリクスを毎回調べるのが面倒」

**ビジネス価値**:
- モニタリング設定の工数削減（推定：1テンプレートあたり2-4時間の短縮）
- 監視漏れリスクの低減
- チーム内知識の標準化
- 後続のアラーム自動生成への基盤提供

### 1.2 対象リソースと選定根拠

以下6つのAWSリソースを対象とする：

| リソース | 理由 | 使用頻度 |
|----------|------|----------|
| Amazon RDS | データベース障害の影響大、メトリクス種類多数 | 高 |
| AWS Lambda | サーバーレス主要サービス、パフォーマンス可視化重要 | 高 |
| Amazon ECS (Fargate) | コンテナ実行基盤、リソース使用量監視必須 | 中〜高 |
| Application Load Balancer | フロントエンドの単一障害点、レスポンス監視重要 | 高 |
| Amazon DynamoDB | 高速データアクセス要求、スロットリング監視必要 | 中〜高 |
| Amazon API Gateway | API提供の入口、レート制限とエラー率監視必須 | 中 |

## 2. 機能要件（EARS記法準拠）

### 2.1 テンプレート解析機能

**R-001: テンプレートファイル読み込み**
- **Event**: ユーザーがCLI経由でCloudFormationテンプレートファイル（.yaml/.json）のパスを指定したとき
- **Action**: システムはファイルの存在確認、読み取り権限確認を行い、ファイル内容をメモリに読み込む
- **Response**: 読み込み成功時は処理継続、失敗時は具体的エラー内容（ファイル名、エラー種別、推奨対処法）を標準エラー出力に表示
- **Scale**: ファイルサイズ50MB以下を5秒以内、権限エラー等は1秒以内にレスポンス

**R-002: テンプレート構文解析**
- **Event**: ファイル読み込みが成功したとき
- **Action**: システムはYAML/JSON構文解析を実行し、CloudFormationテンプレート構造の妥当性を検証する
- **Response**: 解析成功時は内部データ構造を生成、失敗時は行番号付きエラーメッセージを表示
- **Scale**: 構文解析を10秒以内、エラー時の詳細分析を5秒以内に完了

**R-003: 対象リソース抽出**
- **Event**: テンプレート構文解析が成功したとき
- **Action**: システムは`Resources`セクションを走査し、対象6リソースタイプに合致するリソースを特定する
- **Response**: 発見リソースの論理ID、タイプ、関連プロパティ（名前、サイズ等）をリスト化して返す
- **Scale**: 1テンプレートあたり最大500リソース、抽出処理を3秒以内に完了

### 2.2 メトリクス情報生成機能

**R-004: RDSメトリクス生成**
- **Event**: AWS::RDS::DBInstanceリソースが抽出されたとき
- **Action**: システムは当該インスタンスの設定（エンジンタイプ、マルチAZ等）を分析し、適用可能なCloudWatchメトリクス一覧を生成する
- **Response**: メトリクス名、単位、説明、推奨統計手法、警告しきい値、重要度レベルを含む構造化データを返す
- **Scale**: RDSインスタンス1個あたり25個程度のメトリクスを2秒以内に生成

**R-005: Lambdaメトリクス生成**
- **Event**: AWS::Lambda::Function または AWS::Serverless::Functionリソースが抽出されたとき  
- **Action**: システムは関数設定（ランタイム、タイムアウト、メモリ等）を分析し、適用可能なメトリクス一覧を生成する
- **Response**: 実行メトリクス、エラーメトリクス、パフォーマンスメトリクスを含む構造化データを返す
- **Scale**: Lambda関数1個あたり18個程度のメトリクスを1秒以内に生成

**R-006: ECS Fargateメトリクス生成**
- **Event**: AWS::ECS::ServiceかつLaunchType=FARGATEのリソースが抽出されたとき
- **Action**: システムはサービス設定（CPU、メモリ、DesiredCount等）を分析し、適用可能なメトリクス一覧を生成する
- **Response**: コンテナレベルとサービスレベルのメトリクスを含む構造化データを返す
- **Scale**: ECSサービス1個あたり15個程度のメトリクスを1秒以内に生成

**R-007: ALBメトリクス生成**
- **Event**: AWS::ElasticLoadBalancingV2::LoadBalancerでType=applicationのリソースが抽出されたとき
- **Action**: システムは設定（スキーム、リスナー等）を分析し、適用可能なメトリクス一覧を生成する
- **Response**: トラフィック、レスポンス時間、エラー率メトリクスを含む構造化データを返す
- **Scale**: ALB1個あたり20個程度のメトリクスを1秒以内に生成

**R-008: DynamoDBメトリクス生成**
- **Event**: AWS::DynamoDB::Tableリソースが抽出されたとき
- **Action**: システムはテーブル設定（BillingMode、GlobalSecondaryIndexes等）を分析し、適用可能なメトリクス一覧を生成する
- **Response**: 読み書きメトリクス、容量メトリクス、エラーメトリクスを含む構造化データを返す
- **Scale**: DynamoDBテーブル1個あたり22個程度のメトリクスを1秒以内に生成

**R-009: API Gatewayメトリクス生成**
- **Event**: AWS::ApiGateway::RestApi または AWS::Serverless::Apiリソースが抽出されたとき
- **Action**: システムはAPI設定を分析し、適用可能なメトリクス一覧を生成する
- **Response**: リクエスト数、レスポンス時間、エラー率メトリクスを含む構造化データを返す
- **Scale**: API Gateway1個あたり16個程度のメトリクスを1秒以内に生成

### 2.3 結果出力機能

**R-010: JSON形式出力**
- **Event**: ユーザーが`--output json`オプションを指定したとき
- **Action**: システムは収集されたメトリクス情報を定義済みJSONスキーマに従って整形する
- **Response**: 標準出力にJSON形式の構造化データを出力する
- **Scale**: 出力データサイズ5MB以下の場合、整形処理を2秒以内に完了

**R-011: HTML形式出力**
- **Event**: ユーザーが`--output html`オプションを指定したとき
- **Action**: システムは収集されたメトリクス情報をHTMLレポート形式に整形し、リソース別セクションとメトリクス詳細テーブルを生成する
- **Response**: 指定パスまたは標準出力にHTMLレポートを出力する
- **Scale**: HTMLレポート生成を3秒以内に完了

### 2.4 エラーハンドリング機能

**R-012: ファイルアクセスエラー対応**
- **Event**: 指定されたテンプレートファイルが存在しない、読み取り権限がない、または破損している場合
- **Action**: システムはエラー種別を特定し、問題解決に必要な情報を収集する
- **Response**: エラー種別、ファイルパス、推奨対処法を含む構造化エラーメッセージを標準エラー出力に表示し、終了コード1で終了
- **Scale**: エラー検出から1秒以内にエラーレスポンス

**R-013: テンプレート構文エラー対応**
- **Event**: CloudFormationテンプレートにYAML/JSON構文エラー、または必須セクション欠如がある場合
- **Action**: システムは構文エラーの位置と内容を特定し、修正提案を生成する
- **Response**: 行番号、列番号、エラー内容、修正例を含むエラーメッセージを表示し、終了コード2で終了
- **Scale**: 構文解析エラー検出から3秒以内にエラーレスポンス

**R-014: リソース処理エラー対応**
- **Event**: 対象リソースの設定値が不正、または想定外の組み合わせの場合
- **Action**: システムはリソース固有のエラー内容を特定し、警告レベルの判定を行う
- **Response**: リソース論理ID、エラー内容、警告レベル（ERROR/WARNING）を表示し、ERRORの場合は処理継続、WARNINGの場合はスキップ
- **Scale**: リソース処理エラー検出から2秒以内にレスポンス

## 3. 非機能要件

### 3.1 性能要件
- **システム全体応答時間**: 通常サイズテンプレート（リソース数100以下）の処理を30秒以内
- **メモリ使用量**: 処理中のピーク使用量を256MB以下に制限
- **並行処理**: 複数リソースタイプのメトリクス生成を並行実行し、処理時間を最大50%短縮

### 3.2 信頼性要件
- **可用性**: 正常なテンプレートファイルに対して99%以上の成功率
- **エラーハンドリング**: 想定される全エラーケースで適切なエラーメッセージを表示
- **データ整合性**: 出力データがJSONスキーマ定義に100%適合

### 3.3 保守性要件
- **拡張性**: 新規リソースタイプ追加時の既存コードへの影響を20%以下に抑制
- **設定外部化**: メトリクス定義を外部設定ファイル（YAML）で管理
- **ログ出力**: デバッグ用途の詳細ログ出力機能（`--verbose`オプション）

### 3.4 互換性要件
- **テンプレート対応**: CloudFormation、SAM、CDK合成後テンプレートに対応
- **OS対応**: Linux (Ubuntu 20.04+)、macOS (Big Sur+)、Windows 10+で動作
- **Node.js対応**: Node.js 18.x以上での動作保証

## 4. 技術仕様

### 4.1 メトリクス情報データソース
- **一次情報源**: AWS公式CloudWatchメトリクスドキュメント
- **推奨値算出**: AWS Well-Architectedフレームワークのベストプラクティス
- **更新頻度**: 四半期ごとに最新AWS情報との同期

### 4.2 出力データ形式

#### JSON出力スキーマ
```json
{
  "metadata": {
    "version": "1.0.0",
    "generated_at": "ISO-8601形式",
    "template_path": "string",
    "total_resources": "number",
    "supported_resources": "number"
  },
  "resources": [
    {
      "logical_id": "string",
      "resource_type": "string",
      "resource_properties": {},
      "metrics": [
        {
          "metric_name": "string",
          "namespace": "string", 
          "unit": "string",
          "description": "string",
          "statistic": "string",
          "recommended_threshold": {
            "warning": "number",
            "critical": "number"
          },
          "evaluation_period": "number",
          "category": "Performance|Error|Saturation|Latency",
          "importance": "High|Medium|Low"
        }
      ]
    }
  ],
  "unsupported_resources": ["string"]
}
```

#### HTML出力仕様
- レスポンシブWebデザイン（Bootstrap 5.x使用）
- リソース別タブ表示
- メトリクス重要度別色分け
- フィルタリング・検索機能
- エクスポート機能（CSV、PDF）

### 4.3 CLI インターフェース設計

```bash
# 基本使用法
aws-cloud-supporter metrics [OPTIONS] <template-file>

# オプション
--output, -o        出力形式 (json|html|yaml) [default: json]
--output-file, -f   出力ファイルパス [default: stdout]  
--resource-types    対象リソースタイプ [default: all]
--include-low       重要度Lowのメトリクスを含める
--verbose, -v       詳細ログ出力
--help, -h          ヘルプ表示
--version           バージョン表示

# 使用例
aws-cloud-supporter metrics template.yaml
aws-cloud-supporter metrics -o html -f report.html template.yaml
aws-cloud-supporter metrics --resource-types RDS,Lambda template.yaml
```

## 5. 制約事項と前提条件

### 5.1 技術的制約
- CloudFormation組み込み関数（`!Ref`、`!GetAtt`等）の動的評価は行わない
- パラメータ値の実行時解決は対象外
- ネストされたスタック（AWS::CloudFormation::Stack）は対象外
- 条件分岐（Conditions）による動的リソース作成は考慮しない

### 5.2 前提条件
- 入力テンプレートはCloudFormation構文に準拠していること
- システム実行環境にNode.js 18.x以上がインストール済みであること
- テンプレートファイルに対する読み取り権限があること

### 5.3 除外事項
- 実際のAWSアカウントへの接続・認証は行わない
- デプロイ済みリソースのメトリクス値取得は対象外
- リアルタイム監視機能は提供しない
- アラーム設定の自動生成は次フェーズ対応（本フェーズは情報提供のみ）

## 6. 受入基準

### 6.1 機能受入基準
- [ ] 6つの対象リソースタイプすべてでメトリクス生成が可能
- [ ] JSON/HTML両形式での出力が正常動作  
- [ ] エラーケースで適切なエラーメッセージが表示される
- [ ] サンプルテンプレート6件での動作確認が完了
- [ ] 出力JSONがスキーマ定義に100%適合

### 6.2 性能受入基準
- [ ] リソース数50以下のテンプレートを20秒以内で処理
- [ ] メモリ使用量が256MB以下で安定動作
- [ ] 並行処理により単一スレッド比30%以上の性能向上

### 6.3 品質受入基準
- [ ] 単体テストカバレッジ90%以上
- [ ] エラーケーステスト20パターン以上で検証済み
- [ ] HTMLレポートがモダンブラウザで正常表示
- [ ] CLIヘルプとドキュメントが整備済み

---

**要件定義書作成者**: Claude Code  
**レビュー実施日**: 2025-09-08  
**承認**: 要承認  
**バージョン**: 1.1