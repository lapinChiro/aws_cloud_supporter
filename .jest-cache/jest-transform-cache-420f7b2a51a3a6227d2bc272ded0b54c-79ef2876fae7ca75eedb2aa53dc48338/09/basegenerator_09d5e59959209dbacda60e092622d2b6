dd8fe57cf75632e070a652851c5bef51
"use strict";
// CLAUDE.md準拠BaseMetricsGenerator（SOLID抽象化原則 + Type-Driven Development）
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricsGenerationMonitor = exports.BaseMetricsGenerator = void 0;
exports.validateMetricDefinition = validateMetricDefinition;
const error_1 = require("../utils/error");
// SOLID原則: 抽象化による拡張性確保（Open/Closed Principle）
class BaseMetricsGenerator {
    logger;
    constructor(logger) {
        this.logger = logger;
    }
    // メイン生成メソッド（CLAUDE.md: Type-Driven Development）
    async generate(resource) {
        const startTime = performance.now();
        try {
            // 型安全なリソース検証
            this.validateResource(resource);
            // 適用可能メトリクス決定
            const applicableConfigs = this.getApplicableMetrics(resource);
            // メトリクス定義生成（型安全性重視）
            const metrics = applicableConfigs.map(config => this.buildMetricDefinition(resource, config));
            const duration = performance.now() - startTime;
            // パフォーマンス監視（CLAUDE.md: 性能要件）
            if (duration > 1000) {
                this.logger.warn(`Metrics generation slow: ${duration.toFixed(0)}ms for ${this.getResourceId(resource)}`);
            }
            else {
                this.logger.debug(`Generated ${metrics.length} metrics for ${this.getResourceId(resource)} in ${duration.toFixed(1)}ms`);
            }
            return metrics;
        }
        catch (error) {
            const resourceId = this.getResourceId(resource);
            this.logger.error(`Failed to generate metrics for ${resourceId}`, error);
            throw (0, error_1.createResourceError)(`Metrics generation failed for ${resourceId}: ${error.message}`, { resourceType: resource.Type, originalError: error.message });
        }
    }
    // 適用可能メトリクス判定（Type-Driven Development）
    getApplicableMetrics(resource) {
        const allConfigs = this.getMetricsConfig(resource);
        return allConfigs.filter(config => {
            if (!config.applicableWhen) {
                return true; // 条件なしは全て適用
            }
            try {
                return config.applicableWhen(resource);
            }
            catch (error) {
                this.logger.warn(`Failed to evaluate metric condition: ${config.name}`, error);
                return false; // 評価失敗時は適用しない
            }
        });
    }
    // メトリクス定義構築（型安全性重視）
    buildMetricDefinition(resource, config) {
        const threshold = this.calculateThreshold(resource, config);
        return {
            metric_name: config.name,
            namespace: config.namespace,
            unit: config.unit,
            description: config.description,
            statistic: config.statistic,
            recommended_threshold: threshold,
            evaluation_period: config.evaluationPeriod,
            category: config.category,
            importance: config.importance,
            dimensions: this.buildDimensions(resource, config)
        };
    }
    // 動的しきい値計算（CLAUDE.md: アルゴリズム実装）
    calculateThreshold(resource, config) {
        // リソーススケール係数取得
        const scale = this.getResourceScale(resource);
        const base = config.threshold.base;
        // 動的計算（CLAUDE.md: Type-Driven Development）
        const warning = Math.round(base * scale * config.threshold.warningMultiplier);
        const critical = Math.round(base * scale * config.threshold.criticalMultiplier);
        // しきい値妥当性検証（warning < critical）
        if (warning >= critical) {
            this.logger.warn(`Invalid threshold calculation: warning=${warning} >= critical=${critical} for ${config.name}`);
            // 自動修正（critical = warning * 1.5）
            const correctedCritical = Math.round(warning * 1.5);
            this.logger.info(`Auto-corrected critical threshold: ${critical} → ${correctedCritical}`);
            return {
                warning,
                critical: correctedCritical
            };
        }
        return { warning, critical };
    }
    // CloudWatchディメンション構築（AWS仕様準拠）
    buildDimensions(resource, config) {
        const resourceId = this.getResourceId(resource);
        const primaryDimension = this.getPrimaryDimensionName(resource.Type);
        return [
            {
                name: primaryDimension,
                value: resourceId
            }
        ];
    }
    // リソースタイプ別プライマリディメンション（AWS CloudWatch仕様）
    getPrimaryDimensionName(resourceType) {
        const dimensionMap = {
            'AWS::RDS::DBInstance': 'DBInstanceIdentifier',
            'AWS::Lambda::Function': 'FunctionName',
            'AWS::Serverless::Function': 'FunctionName',
            'AWS::ECS::Service': 'ServiceName',
            'AWS::ElasticLoadBalancingV2::LoadBalancer': 'LoadBalancer',
            'AWS::DynamoDB::Table': 'TableName',
            'AWS::ApiGateway::RestApi': 'ApiName',
            'AWS::Serverless::Api': 'ApiName'
        };
        return dimensionMap[resourceType] ?? 'ResourceId';
    }
    // 型安全なリソースID取得
    getResourceId(resource) {
        // LogicalIdプロパティの型安全取得
        const resourceWithId = resource;
        return resourceWithId.LogicalId ?? 'UnknownResource';
    }
    // リソース基本検証（型安全性）
    validateResource(resource) {
        if (!resource.Type || typeof resource.Type !== 'string') {
            throw (0, error_1.createResourceError)('Resource must have a valid Type property', { resourceData: JSON.stringify(resource) });
        }
        if (!this.getSupportedTypes().includes(resource.Type)) {
            throw (0, error_1.createResourceError)(`Unsupported resource type: ${resource.Type}`, {
                resourceType: resource.Type,
                supportedTypes: this.getSupportedTypes()
            });
        }
    }
}
exports.BaseMetricsGenerator = BaseMetricsGenerator;
// パフォーマンス測定ヘルパー（CLAUDE.md: 単一責任分離）
class MetricsGenerationMonitor {
    static async measureGenerationPerformance(generator, resource) {
        const startTime = performance.now();
        const memoryBefore = process.memoryUsage().heapUsed;
        const metrics = await generator.generate(resource);
        const duration = performance.now() - startTime;
        const memoryAfter = process.memoryUsage().heapUsed;
        const memoryDelta = (memoryAfter - memoryBefore) / 1024 / 1024;
        // 統計情報計算
        const stats = {
            resourceType: resource.Type,
            metricsGenerated: metrics.length,
            generationTimeMs: Math.round(duration),
            averageThresholdWarning: metrics.reduce((sum, m) => sum + m.recommended_threshold.warning, 0) / metrics.length,
            averageThresholdCritical: metrics.reduce((sum, m) => sum + m.recommended_threshold.critical, 0) / metrics.length
        };
        // パフォーマンス評価
        let performanceGrade;
        if (duration < 100 && memoryDelta < 1) {
            performanceGrade = 'A'; // 100ms以下、メモリ1MB以下
        }
        else if (duration < 500 && memoryDelta < 5) {
            performanceGrade = 'B'; // 500ms以下、メモリ5MB以下
        }
        else if (duration < 1000 && memoryDelta < 10) {
            performanceGrade = 'C'; // 1秒以下、メモリ10MB以下
        }
        else {
            performanceGrade = 'F'; // 要件超過
        }
        return {
            metrics,
            stats,
            performanceGrade
        };
    }
}
exports.MetricsGenerationMonitor = MetricsGenerationMonitor;
// 型安全なメトリクス検証（CLAUDE.md: Type-Driven Development）
function validateMetricDefinition(metric) {
    const errors = [];
    // 必須フィールド検証
    if (!metric.metric_name || typeof metric.metric_name !== 'string') {
        errors.push('metric_name must be a non-empty string');
    }
    if (!metric.namespace || typeof metric.namespace !== 'string') {
        errors.push('namespace must be a non-empty string');
    }
    // しきい値妥当性検証（カスタムマッチャーと同じロジック）
    const threshold = metric.recommended_threshold;
    if (threshold.warning >= threshold.critical) {
        errors.push(`Invalid threshold: warning(${threshold.warning}) >= critical(${threshold.critical})`);
    }
    if (threshold.warning <= 0 || threshold.critical <= 0) {
        errors.push('Thresholds must be positive numbers');
    }
    // 評価期間検証
    const validPeriods = [60, 300, 900, 3600]; // CloudWatch標準期間
    if (!validPeriods.includes(metric.evaluation_period)) {
        errors.push(`Invalid evaluation_period: ${metric.evaluation_period}. Valid: ${validPeriods.join(', ')}`);
    }
    return {
        isValid: errors.length === 0,
        errors
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvc3JjL2dlbmVyYXRvcnMvYmFzZS5nZW5lcmF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHdFQUF3RTs7O0FBaVB4RSw0REFtQ0M7QUEvUUQsMENBQXFEO0FBRXJELDhDQUE4QztBQUM5QyxNQUFzQixvQkFBb0I7SUFFbEI7SUFBdEIsWUFBc0IsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7SUFBRyxDQUFDO0lBT3pDLGdEQUFnRDtJQUNoRCxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQWdDO1FBQzdDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVwQyxJQUFJLENBQUM7WUFDSCxhQUFhO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWhDLGNBQWM7WUFDZCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU5RCxvQkFBb0I7WUFDcEIsTUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQzdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQzdDLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBRS9DLDZCQUE2QjtZQUM3QixJQUFJLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDNUcsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsT0FBTyxDQUFDLE1BQU0sZ0JBQWdCLElBQUksQ0FB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Q0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxTQUFTO0lBQ1QsTUFBTSxZQUFZLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLGlCQUFpQjtJQUM1RCxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1FBQ3JELE1BQU0sQ0FBQyxJQUFJLENBQUMsOEJBQThCLE1BQU0sQ0FBQyxpQkFBaUIsWUFBWSxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMzRyxDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sRUFBRSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUM7UUFDNUIsTUFBTTtLQUNQLENBQUM7QUFDSixDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2t5b2hlaS9hd3NfY2xvdWRfc3VwcG9ydGVyL3NyYy9nZW5lcmF0b3JzL2Jhc2UuZ2VuZXJhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENMQVVERS5tZOa6luaLoEJhc2VNZXRyaWNzR2VuZXJhdG9y77yIU09MSUTmir3osaHljJbljp/liYcgKyBUeXBlLURyaXZlbiBEZXZlbG9wbWVudO+8iVxuXG5pbXBvcnQgeyBDbG91ZEZvcm1hdGlvblJlc291cmNlIH0gZnJvbSAnLi4vdHlwZXMvY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgTWV0cmljRGVmaW5pdGlvbiwgTWV0cmljQ29uZmlnLCBJTWV0cmljc0dlbmVyYXRvciB9IGZyb20gJy4uL3R5cGVzL21ldHJpY3MnO1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gJy4uL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBjcmVhdGVSZXNvdXJjZUVycm9yIH0gZnJvbSAnLi4vdXRpbHMvZXJyb3InO1xuXG4vLyBTT0xJROWOn+WJhzog5oq96LGh5YyW44Gr44KI44KL5ouh5by15oCn56K65L+d77yIT3Blbi9DbG9zZWQgUHJpbmNpcGxl77yJXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZU1ldHJpY3NHZW5lcmF0b3IgaW1wbGVtZW50cyBJTWV0cmljc0dlbmVyYXRvciB7XG4gIFxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgbG9nZ2VyOiBJTG9nZ2VyKSB7fVxuXG4gIC8vIOaKveixoeODoeOCveODg+ODiee+pO+8iFNPTElEOiBJbnRlcmZhY2UgU2VncmVnYXRpb27vvIlcbiAgYWJzdHJhY3QgZ2V0U3VwcG9ydGVkVHlwZXMoKTogc3RyaW5nW107XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRNZXRyaWNzQ29uZmlnKHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlKTogTWV0cmljQ29uZmlnW107XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRSZXNvdXJjZVNjYWxlKHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlKTogbnVtYmVyO1xuXG4gIC8vIOODoeOCpOODs+eUn+aIkOODoeOCveODg+ODie+8iENMQVVERS5tZDogVHlwZS1Ecml2ZW4gRGV2ZWxvcG1lbnTvvIlcbiAgYXN5bmMgZ2VuZXJhdGUocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBQcm9taXNlPE1ldHJpY0RlZmluaXRpb25bXT4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyDlnovlronlhajjgarjg6rjgr3jg7zjgrnmpJzoqLxcbiAgICAgIHRoaXMudmFsaWRhdGVSZXNvdXJjZShyZXNvdXJjZSk7XG4gICAgICBcbiAgICAgIC8vIOmBqeeUqOWPr+iDveODoeODiOODquOCr+OCueaxuuWumlxuICAgICAgY29uc3QgYXBwbGljYWJsZUNvbmZpZ3MgPSB0aGlzLmdldEFwcGxpY2FibGVNZXRyaWNzKHJlc291cmNlKTtcbiAgICAgIFxuICAgICAgLy8g44Oh44OI44Oq44Kv44K55a6a576p55Sf5oiQ77yI5Z6L5a6J5YWo5oCn6YeN6KaW77yJXG4gICAgICBjb25zdCBtZXRyaWNzID0gYXBwbGljYWJsZUNvbmZpZ3MubWFwKGNvbmZpZyA9PiBcbiAgICAgICAgdGhpcy5idWlsZE1ldHJpY0RlZmluaXRpb24ocmVzb3VyY2UsIGNvbmZpZylcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBcbiAgICAgIC8vIOODkeODleOCqeODvOODnuODs+OCueebo+imlu+8iENMQVVERS5tZDog5oCn6IO96KaB5Lu277yJXG4gICAgICBpZiAoZHVyYXRpb24gPiAxMDAwKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE1ldHJpY3MgZ2VuZXJhdGlvbiBzbG93OiAke2R1cmF0aW9uLnRvRml4ZWQoMCl9bXMgZm9yICR7dGhpcy5nZXRSZXNvdXJjZUlkKHJlc291cmNlKX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBHZW5lcmF0ZWQgJHttZXRyaWNzLmxlbmd0aH0gbWV0cmljcyBmb3IgJHt0aGlzLmdldFJlc291cmNlSWQocmVzb3VyY2UpfSBpbiAke2R1cmF0aW9uLnRvRml4ZWQoMSl9bXNgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG1ldHJpY3M7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IHJlc291cmNlSWQgPSB0aGlzLmdldFJlc291cmNlSWQocmVzb3VyY2UpO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBnZW5lcmF0ZSBtZXRyaWNzIGZvciAke3Jlc291cmNlSWR9YCwgZXJyb3IgYXMgRXJyb3IpO1xuICAgICAgdGhyb3cgY3JlYXRlUmVzb3VyY2VFcnJvcihcbiAgICAgICAgYE1ldHJpY3MgZ2VuZXJhdGlvbiBmYWlsZWQgZm9yICR7cmVzb3VyY2VJZH06ICR7KGVycm9yIGFzIEVycm9yKS5tZXNzYWdlfWAsXG4gICAgICAgIHsgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5UeXBlLCBvcmlnaW5hbEVycm9yOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvLyDpgannlKjlj6/og73jg6Hjg4jjg6rjgq/jgrnliKTlrprvvIhUeXBlLURyaXZlbiBEZXZlbG9wbWVudO+8iVxuICBwcml2YXRlIGdldEFwcGxpY2FibGVNZXRyaWNzKHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlKTogTWV0cmljQ29uZmlnW10ge1xuICAgIGNvbnN0IGFsbENvbmZpZ3MgPSB0aGlzLmdldE1ldHJpY3NDb25maWcocmVzb3VyY2UpO1xuICAgIFxuICAgIHJldHVybiBhbGxDb25maWdzLmZpbHRlcihjb25maWcgPT4ge1xuICAgICAgaWYgKCFjb25maWcuYXBwbGljYWJsZVdoZW4pIHtcbiAgICAgICAgcmV0dXJuIHRydWU7IC8vIOadoeS7tuOBquOBl+OBr+WFqOOBpumBqeeUqFxuICAgICAgfVxuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gY29uZmlnLmFwcGxpY2FibGVXaGVuKHJlc291cmNlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEZhaWxlZCB0byBldmFsdWF0ZSBtZXRyaWMgY29uZGl0aW9uOiAke2NvbmZpZy5uYW1lfWAsIGVycm9yIGFzIEVycm9yKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyDoqZXkvqHlpLHmlZfmmYLjga/pgannlKjjgZfjgarjgYRcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8vIOODoeODiOODquOCr+OCueWumue+qeani+evie+8iOWei+WuieWFqOaAp+mHjeimlu+8iVxuICBwcml2YXRlIGJ1aWxkTWV0cmljRGVmaW5pdGlvbihcbiAgICByZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSxcbiAgICBjb25maWc6IE1ldHJpY0NvbmZpZ1xuICApOiBNZXRyaWNEZWZpbml0aW9uIHtcbiAgICBjb25zdCB0aHJlc2hvbGQgPSB0aGlzLmNhbGN1bGF0ZVRocmVzaG9sZChyZXNvdXJjZSwgY29uZmlnKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgbWV0cmljX25hbWU6IGNvbmZpZy5uYW1lLFxuICAgICAgbmFtZXNwYWNlOiBjb25maWcubmFtZXNwYWNlLFxuICAgICAgdW5pdDogY29uZmlnLnVuaXQsXG4gICAgICBkZXNjcmlwdGlvbjogY29uZmlnLmRlc2NyaXB0aW9uLFxuICAgICAgc3RhdGlzdGljOiBjb25maWcuc3RhdGlzdGljLFxuICAgICAgcmVjb21tZW5kZWRfdGhyZXNob2xkOiB0aHJlc2hvbGQsXG4gICAgICBldmFsdWF0aW9uX3BlcmlvZDogY29uZmlnLmV2YWx1YXRpb25QZXJpb2QsXG4gICAgICBjYXRlZ29yeTogY29uZmlnLmNhdGVnb3J5LFxuICAgICAgaW1wb3J0YW5jZTogY29uZmlnLmltcG9ydGFuY2UsXG4gICAgICBkaW1lbnNpb25zOiB0aGlzLmJ1aWxkRGltZW5zaW9ucyhyZXNvdXJjZSwgY29uZmlnKVxuICAgIH07XG4gIH1cblxuICAvLyDli5XnmoTjgZfjgY3jgYTlgKToqIjnrpfvvIhDTEFVREUubWQ6IOOCouODq+OCtOODquOCuuODoOWun+ijhe+8iVxuICBwcml2YXRlIGNhbGN1bGF0ZVRocmVzaG9sZChcbiAgICByZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSxcbiAgICBjb25maWc6IE1ldHJpY0NvbmZpZ1xuICApOiB7IHdhcm5pbmc6IG51bWJlcjsgY3JpdGljYWw6IG51bWJlciB9IHtcbiAgICAvLyDjg6rjgr3jg7zjgrnjgrnjgrHjg7zjg6vkv4LmlbDlj5blvpdcbiAgICBjb25zdCBzY2FsZSA9IHRoaXMuZ2V0UmVzb3VyY2VTY2FsZShyZXNvdXJjZSk7XG4gICAgY29uc3QgYmFzZSA9IGNvbmZpZy50aHJlc2hvbGQuYmFzZTtcbiAgICBcbiAgICAvLyDli5XnmoToqIjnrpfvvIhDTEFVREUubWQ6IFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG4gICAgY29uc3Qgd2FybmluZyA9IE1hdGgucm91bmQoYmFzZSAqIHNjYWxlICogY29uZmlnLnRocmVzaG9sZC53YXJuaW5nTXVsdGlwbGllcik7XG4gICAgY29uc3QgY3JpdGljYWwgPSBNYXRoLnJvdW5kKGJhc2UgKiBzY2FsZSAqIGNvbmZpZy50aHJlc2hvbGQuY3JpdGljYWxNdWx0aXBsaWVyKTtcbiAgICBcbiAgICAvLyDjgZfjgY3jgYTlgKTlpqXlvZPmgKfmpJzoqLzvvIh3YXJuaW5nIDwgY3JpdGljYWzvvIlcbiAgICBpZiAod2FybmluZyA+PSBjcml0aWNhbCkge1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgSW52YWxpZCB0aHJlc2hvbGQgY2FsY3VsYXRpb246IHdhcm5pbmc9JHt3YXJuaW5nfSA+PSBjcml0aWNhbD0ke2NyaXRpY2FsfSBmb3IgJHtjb25maWcubmFtZX1gKTtcbiAgICAgIFxuICAgICAgLy8g6Ieq5YuV5L+u5q2j77yIY3JpdGljYWwgPSB3YXJuaW5nICogMS4177yJXG4gICAgICBjb25zdCBjb3JyZWN0ZWRDcml0aWNhbCA9IE1hdGgucm91bmQod2FybmluZyAqIDEuNSk7XG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKGBBdXRvLWNvcnJlY3RlZCBjcml0aWNhbCB0aHJlc2hvbGQ6ICR7Y3JpdGljYWx9IOKGkiAke2NvcnJlY3RlZENyaXRpY2FsfWApO1xuICAgICAgXG4gICAgICByZXR1cm4ge1xuICAgICAgICB3YXJuaW5nLFxuICAgICAgICBjcml0aWNhbDogY29ycmVjdGVkQ3JpdGljYWxcbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7IHdhcm5pbmcsIGNyaXRpY2FsIH07XG4gIH1cblxuICAvLyBDbG91ZFdhdGNo44OH44Kj44Oh44Oz44K344On44Oz5qeL56+J77yIQVdT5LuV5qeY5rqW5oug77yJXG4gIHByaXZhdGUgYnVpbGREaW1lbnNpb25zKFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlLFxuICAgIGNvbmZpZzogTWV0cmljQ29uZmlnXG4gICk6IEFycmF5PHsgbmFtZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH0+IHtcbiAgICBjb25zdCByZXNvdXJjZUlkID0gdGhpcy5nZXRSZXNvdXJjZUlkKHJlc291cmNlKTtcbiAgICBjb25zdCBwcmltYXJ5RGltZW5zaW9uID0gdGhpcy5nZXRQcmltYXJ5RGltZW5zaW9uTmFtZShyZXNvdXJjZS5UeXBlKTtcbiAgICBcbiAgICByZXR1cm4gW1xuICAgICAge1xuICAgICAgICBuYW1lOiBwcmltYXJ5RGltZW5zaW9uLFxuICAgICAgICB2YWx1ZTogcmVzb3VyY2VJZFxuICAgICAgfVxuICAgIF07XG4gIH1cblxuICAvLyDjg6rjgr3jg7zjgrnjgr/jgqTjg5fliKXjg5fjg6njgqTjg57jg6rjg4fjgqPjg6Hjg7Pjgrfjg6fjg7PvvIhBV1MgQ2xvdWRXYXRjaOS7leanmO+8iVxuICBwcml2YXRlIGdldFByaW1hcnlEaW1lbnNpb25OYW1lKHJlc291cmNlVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBkaW1lbnNpb25NYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAnQVdTOjpSRFM6OkRCSW5zdGFuY2UnOiAnREJJbnN0YW5jZUlkZW50aWZpZXInLFxuICAgICAgJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbic6ICdGdW5jdGlvbk5hbWUnLFxuICAgICAgJ0FXUzo6U2VydmVybGVzczo6RnVuY3Rpb24nOiAnRnVuY3Rpb25OYW1lJyxcbiAgICAgICdBV1M6OkVDUzo6U2VydmljZSc6ICdTZXJ2aWNlTmFtZScsXG4gICAgICAnQVdTOjpFbGFzdGljTG9hZEJhbGFuY2luZ1YyOjpMb2FkQmFsYW5jZXInOiAnTG9hZEJhbGFuY2VyJyxcbiAgICAgICdBV1M6OkR5bmFtb0RCOjpUYWJsZSc6ICdUYWJsZU5hbWUnLFxuICAgICAgJ0FXUzo6QXBpR2F0ZXdheTo6UmVzdEFwaSc6ICdBcGlOYW1lJyxcbiAgICAgICdBV1M6OlNlcnZlcmxlc3M6OkFwaSc6ICdBcGlOYW1lJ1xuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIGRpbWVuc2lvbk1hcFtyZXNvdXJjZVR5cGVdID8/ICdSZXNvdXJjZUlkJztcbiAgfVxuXG4gIC8vIOWei+WuieWFqOOBquODquOCveODvOOCuUlE5Y+W5b6XXG4gIHByaXZhdGUgZ2V0UmVzb3VyY2VJZChyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IHN0cmluZyB7XG4gICAgLy8gTG9naWNhbElk44OX44Ot44OR44OG44Kj44Gu5Z6L5a6J5YWo5Y+W5b6XXG4gICAgY29uc3QgcmVzb3VyY2VXaXRoSWQgPSByZXNvdXJjZSBhcyBDbG91ZEZvcm1hdGlvblJlc291cmNlICYgeyBMb2dpY2FsSWQ/OiBzdHJpbmcgfTtcbiAgICByZXR1cm4gcmVzb3VyY2VXaXRoSWQuTG9naWNhbElkID8/ICdVbmtub3duUmVzb3VyY2UnO1xuICB9XG5cbiAgLy8g44Oq44K944O844K55Z+65pys5qSc6Ki877yI5Z6L5a6J5YWo5oCn77yJXG4gIHByaXZhdGUgdmFsaWRhdGVSZXNvdXJjZShyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IHZvaWQge1xuICAgIGlmICghcmVzb3VyY2UuVHlwZSB8fCB0eXBlb2YgcmVzb3VyY2UuVHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IGNyZWF0ZVJlc291cmNlRXJyb3IoXG4gICAgICAgICdSZXNvdXJjZSBtdXN0IGhhdmUgYSB2YWxpZCBUeXBlIHByb3BlcnR5JyxcbiAgICAgICAgeyByZXNvdXJjZURhdGE6IEpTT04uc3RyaW5naWZ5KHJlc291cmNlKSB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5nZXRTdXBwb3J0ZWRUeXBlcygpLmluY2x1ZGVzKHJlc291cmNlLlR5cGUpKSB7XG4gICAgICB0aHJvdyBjcmVhdGVSZXNvdXJjZUVycm9yKFxuICAgICAgICBgVW5zdXBwb3J0ZWQgcmVzb3VyY2UgdHlwZTogJHtyZXNvdXJjZS5UeXBlfWAsXG4gICAgICAgIHsgXG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5UeXBlLFxuICAgICAgICAgIHN1cHBvcnRlZFR5cGVzOiB0aGlzLmdldFN1cHBvcnRlZFR5cGVzKClcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuLy8g44Oh44OI44Oq44Kv44K555Sf5oiQ57Wx6KiI5oOF5aCx77yIQ0xBVURFLm1kOiDnm6Poppbjg7vjg4fjg5Djg4PjgrDmlK/mj7TvvIlcbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJhdGlvblN0YXRzIHtcbiAgcmVzb3VyY2VUeXBlOiBzdHJpbmc7XG4gIG1ldHJpY3NHZW5lcmF0ZWQ6IG51bWJlcjtcbiAgZ2VuZXJhdGlvblRpbWVNczogbnVtYmVyO1xuICBhdmVyYWdlVGhyZXNob2xkV2FybmluZzogbnVtYmVyO1xuICBhdmVyYWdlVGhyZXNob2xkQ3JpdGljYWw6IG51bWJlcjtcbn1cblxuLy8g44OR44OV44Kp44O844Oe44Oz44K55ris5a6a44OY44Or44OR44O877yIQ0xBVURFLm1kOiDljZjkuIDosqzku7vliIbpm6LvvIlcbmV4cG9ydCBjbGFzcyBNZXRyaWNzR2VuZXJhdGlvbk1vbml0b3Ige1xuICBcbiAgc3RhdGljIGFzeW5jIG1lYXN1cmVHZW5lcmF0aW9uUGVyZm9ybWFuY2U8VCBleHRlbmRzIEJhc2VNZXRyaWNzR2VuZXJhdG9yPihcbiAgICBnZW5lcmF0b3I6IFQsXG4gICAgcmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2VcbiAgKTogUHJvbWlzZTx7XG4gICAgbWV0cmljczogTWV0cmljRGVmaW5pdGlvbltdO1xuICAgIHN0YXRzOiBHZW5lcmF0aW9uU3RhdHM7XG4gICAgcGVyZm9ybWFuY2VHcmFkZTogJ0EnIHwgJ0InIHwgJ0MnIHwgJ0YnO1xuICB9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgY29uc3QgbWVtb3J5QmVmb3JlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgIFxuICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCBnZW5lcmF0b3IuZ2VuZXJhdGUocmVzb3VyY2UpO1xuICAgIFxuICAgIGNvbnN0IGR1cmF0aW9uID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG4gICAgY29uc3QgbWVtb3J5QWZ0ZXIgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gICAgY29uc3QgbWVtb3J5RGVsdGEgPSAobWVtb3J5QWZ0ZXIgLSBtZW1vcnlCZWZvcmUpIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAvLyDntbHoqIjmg4XloLHoqIjnrpdcbiAgICBjb25zdCBzdGF0czogR2VuZXJhdGlvblN0YXRzID0ge1xuICAgICAgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5UeXBlLFxuICAgICAgbWV0cmljc0dlbmVyYXRlZDogbWV0cmljcy5sZW5ndGgsXG4gICAgICBnZW5lcmF0aW9uVGltZU1zOiBNYXRoLnJvdW5kKGR1cmF0aW9uKSxcbiAgICAgIGF2ZXJhZ2VUaHJlc2hvbGRXYXJuaW5nOiBtZXRyaWNzLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyBtLnJlY29tbWVuZGVkX3RocmVzaG9sZC53YXJuaW5nLCAwKSAvIG1ldHJpY3MubGVuZ3RoLFxuICAgICAgYXZlcmFnZVRocmVzaG9sZENyaXRpY2FsOiBtZXRyaWNzLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyBtLnJlY29tbWVuZGVkX3RocmVzaG9sZC5jcml0aWNhbCwgMCkgLyBtZXRyaWNzLmxlbmd0aFxuICAgIH07XG5cbiAgICAvLyDjg5Hjg5Xjgqnjg7zjg57jg7PjgrnoqZXkvqFcbiAgICBsZXQgcGVyZm9ybWFuY2VHcmFkZTogJ0EnIHwgJ0InIHwgJ0MnIHwgJ0YnO1xuICAgIGlmIChkdXJhdGlvbiA8IDEwMCAmJiBtZW1vcnlEZWx0YSA8IDEpIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnQSc7IC8vIDEwMG1z5Lul5LiL44CB44Oh44Oi44OqMU1C5Lul5LiLXG4gICAgfSBlbHNlIGlmIChkdXJhdGlvbiA8IDUwMCAmJiBtZW1vcnlEZWx0YSA8IDUpIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnQic7IC8vIDUwMG1z5Lul5LiL44CB44Oh44Oi44OqNU1C5Lul5LiLXG4gICAgfSBlbHNlIGlmIChkdXJhdGlvbiA8IDEwMDAgJiYgbWVtb3J5RGVsdGEgPCAxMCkge1xuICAgICAgcGVyZm9ybWFuY2VHcmFkZSA9ICdDJzsgLy8gMeenkuS7peS4i+OAgeODoeODouODqjEwTULku6XkuItcbiAgICB9IGVsc2Uge1xuICAgICAgcGVyZm9ybWFuY2VHcmFkZSA9ICdGJzsgLy8g6KaB5Lu26LaF6YGOXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldHJpY3MsXG4gICAgICBzdGF0cyxcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGVcbiAgICB9O1xuICB9XG59XG5cbi8vIOWei+WuieWFqOOBquODoeODiOODquOCr+OCueaknOiovO+8iENMQVVERS5tZDogVHlwZS1Ecml2ZW4gRGV2ZWxvcG1lbnTvvIlcbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZU1ldHJpY0RlZmluaXRpb24obWV0cmljOiBNZXRyaWNEZWZpbml0aW9uKToge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAvLyDlv4XpoIjjg5XjgqPjg7zjg6vjg4nmpJzoqLxcbiAgaWYgKCFtZXRyaWMubWV0cmljX25hbWUgfHwgdHlwZW9mIG1ldHJpYy5tZXRyaWNfbmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICBlcnJvcnMucHVzaCgnbWV0cmljX25hbWUgbXVzdCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcnKTtcbiAgfVxuICBcbiAgaWYgKCFtZXRyaWMubmFtZXNwYWNlIHx8IHR5cGVvZiBtZXRyaWMubmFtZXNwYWNlICE9PSAnc3RyaW5nJykge1xuICAgIGVycm9ycy5wdXNoKCduYW1lc3BhY2UgbXVzdCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcnKTtcbiAgfVxuXG4gIC8vIOOBl+OBjeOBhOWApOWmpeW9k+aAp+aknOiovO+8iOOCq+OCueOCv+ODoOODnuODg+ODgeODo+ODvOOBqOWQjOOBmOODreOCuOODg+OCr++8iVxuICBjb25zdCB0aHJlc2hvbGQgPSBtZXRyaWMucmVjb21tZW5kZWRfdGhyZXNob2xkO1xuICBpZiAodGhyZXNob2xkLndhcm5pbmcgPj0gdGhyZXNob2xkLmNyaXRpY2FsKSB7XG4gICAgZXJyb3JzLnB1c2goYEludmFsaWQgdGhyZXNob2xkOiB3YXJuaW5nKCR7dGhyZXNob2xkLndhcm5pbmd9KSA+PSBjcml0aWNhbCgke3RocmVzaG9sZC5jcml0aWNhbH0pYCk7XG4gIH1cblxuICBpZiAodGhyZXNob2xkLndhcm5pbmcgPD0gMCB8fCB0aHJlc2hvbGQuY3JpdGljYWwgPD0gMCkge1xuICAgIGVycm9ycy5wdXNoKCdUaHJlc2hvbGRzIG11c3QgYmUgcG9zaXRpdmUgbnVtYmVycycpO1xuICB9XG5cbiAgLy8g6KmV5L6h5pyf6ZaT5qSc6Ki8XG4gIGNvbnN0IHZhbGlkUGVyaW9kcyA9IFs2MCwgMzAwLCA5MDAsIDM2MDBdOyAvLyBDbG91ZFdhdGNo5qiZ5rqW5pyf6ZaTXG4gIGlmICghdmFsaWRQZXJpb2RzLmluY2x1ZGVzKG1ldHJpYy5ldmFsdWF0aW9uX3BlcmlvZCkpIHtcbiAgICBlcnJvcnMucHVzaChgSW52YWxpZCBldmFsdWF0aW9uX3BlcmlvZDogJHttZXRyaWMuZXZhbHVhdGlvbl9wZXJpb2R9LiBWYWxpZDogJHt2YWxpZFBlcmlvZHMuam9pbignLCAnKX1gKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICBlcnJvcnNcbiAgfTtcbn0iXSwidmVyc2lvbiI6M30=