1f5061441bc07da572786587a3f4ac0a
"use strict";
// CLAUDE.md準拠BaseMetricsGenerator（SOLID抽象化原則 + Type-Driven Development）
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricsGenerationMonitor = exports.BaseMetricsGenerator = void 0;
exports.validateMetricDefinition = validateMetricDefinition;
const error_1 = require("../utils/error");
// SOLID原則: 抽象化による拡張性確保（Open/Closed Principle）
class BaseMetricsGenerator {
    logger;
    constructor(logger) {
        this.logger = logger;
    }
    // メイン生成メソッド（CLAUDE.md: Type-Driven Development）
    async generate(resource) {
        const startTime = performance.now();
        try {
            // 型安全なリソース検証
            this.validateResource(resource);
            // 適用可能メトリクス決定
            const applicableConfigs = this.getApplicableMetrics(resource);
            // メトリクス定義生成（型安全性重視）
            const metrics = applicableConfigs.map(config => this.buildMetricDefinition(resource, config));
            const duration = performance.now() - startTime;
            // パフォーマンス監視（CLAUDE.md: 性能要件）
            if (duration > 1000) {
                this.logger.warn(`Metrics generation slow: ${duration.toFixed(0)}ms for ${this.getResourceId(resource)}`);
            }
            else {
                this.logger.debug(`Generated ${metrics.length} metrics for ${this.getResourceId(resource)} in ${duration.toFixed(1)}ms`);
            }
            return metrics;
        }
        catch (error) {
            const resourceId = this.getResourceId(resource);
            this.logger.error(`Failed to generate metrics for ${resourceId}`, error);
            throw (0, error_1.createResourceError)(`Metrics generation failed for ${resourceId}: ${error.message}`, { resourceType: resource.Type, originalError: error.message });
        }
    }
    // 適用可能メトリクス判定（Type-Driven Development）
    getApplicableMetrics(resource) {
        const allConfigs = this.getMetricsConfig(resource);
        return allConfigs.filter(config => {
            if (!config.applicableWhen) {
                return true; // 条件なしは全て適用
            }
            try {
                return config.applicableWhen(resource);
            }
            catch (error) {
                this.logger.warn(`Failed to evaluate metric condition: ${config.name}`, error);
                return false; // 評価失敗時は適用しない
            }
        });
    }
    // メトリクス定義構築（型安全性重視）
    buildMetricDefinition(resource, config) {
        const threshold = this.calculateThreshold(resource, config);
        return {
            metric_name: config.name,
            namespace: config.namespace,
            unit: config.unit,
            description: config.description,
            statistic: config.statistic,
            recommended_threshold: threshold,
            evaluation_period: config.evaluationPeriod,
            category: config.category,
            importance: config.importance,
            dimensions: this.buildDimensions(resource, config)
        };
    }
    // 動的しきい値計算（CLAUDE.md: アルゴリズム実装）
    calculateThreshold(resource, config) {
        // リソーススケール係数取得
        const scale = this.getResourceScale(resource);
        const base = config.threshold.base;
        // 動的計算（CLAUDE.md: Type-Driven Development）
        const warning = Math.round(base * scale * config.threshold.warningMultiplier);
        const critical = Math.round(base * scale * config.threshold.criticalMultiplier);
        // しきい値妥当性検証（warning < critical、最小値保証）
        if (warning >= critical || warning === 0) {
            this.logger.warn(`Invalid threshold calculation: warning=${warning} >= critical=${critical} for ${config.name}`);
            // 最小値保証（CLAUDE.md: 実用性重視）
            const correctedWarning = Math.max(warning, 1);
            const correctedCritical = Math.max(critical, correctedWarning + 1);
            this.logger.info(`Auto-corrected thresholds: warning=${warning}→${correctedWarning}, critical=${critical}→${correctedCritical}`);
            return {
                warning: correctedWarning,
                critical: correctedCritical
            };
        }
        return { warning, critical };
    }
    // CloudWatchディメンション構築（AWS仕様準拠）
    buildDimensions(resource, _config // 将来拡張用（現在未使用）
    ) {
        const resourceId = this.getResourceId(resource);
        const primaryDimension = this.getPrimaryDimensionName(resource.Type);
        return [
            {
                name: primaryDimension,
                value: resourceId
            }
        ];
    }
    // リソースタイプ別プライマリディメンション（AWS CloudWatch仕様）
    getPrimaryDimensionName(resourceType) {
        const dimensionMap = {
            'AWS::RDS::DBInstance': 'DBInstanceIdentifier',
            'AWS::Lambda::Function': 'FunctionName',
            'AWS::Serverless::Function': 'FunctionName',
            'AWS::ECS::Service': 'ServiceName',
            'AWS::ElasticLoadBalancingV2::LoadBalancer': 'LoadBalancer',
            'AWS::DynamoDB::Table': 'TableName',
            'AWS::ApiGateway::RestApi': 'ApiName',
            'AWS::Serverless::Api': 'ApiName'
        };
        return dimensionMap[resourceType] ?? 'ResourceId';
    }
    // 型安全なリソースID取得
    getResourceId(resource) {
        // LogicalIdプロパティの型安全取得
        const resourceWithId = resource;
        return resourceWithId.LogicalId ?? 'UnknownResource';
    }
    // リソース基本検証（型安全性）
    validateResource(resource) {
        if (!resource.Type || typeof resource.Type !== 'string') {
            throw (0, error_1.createResourceError)('Resource must have a valid Type property', { resourceData: JSON.stringify(resource) });
        }
        if (!this.getSupportedTypes().includes(resource.Type)) {
            throw (0, error_1.createResourceError)(`Unsupported resource type: ${resource.Type}`, {
                resourceType: resource.Type,
                supportedTypes: this.getSupportedTypes()
            });
        }
    }
}
exports.BaseMetricsGenerator = BaseMetricsGenerator;
// パフォーマンス測定ヘルパー（CLAUDE.md: 単一責任分離）
class MetricsGenerationMonitor {
    static async measureGenerationPerformance(generator, resource) {
        const startTime = performance.now();
        const memoryBefore = process.memoryUsage().heapUsed;
        const metrics = await generator.generate(resource);
        const duration = performance.now() - startTime;
        const memoryAfter = process.memoryUsage().heapUsed;
        const memoryDelta = (memoryAfter - memoryBefore) / 1024 / 1024;
        // 統計情報計算
        const stats = {
            resourceType: resource.Type,
            metricsGenerated: metrics.length,
            generationTimeMs: Math.round(duration),
            averageThresholdWarning: metrics.reduce((sum, m) => sum + m.recommended_threshold.warning, 0) / metrics.length,
            averageThresholdCritical: metrics.reduce((sum, m) => sum + m.recommended_threshold.critical, 0) / metrics.length
        };
        // パフォーマンス評価
        let performanceGrade;
        if (duration < 100 && memoryDelta < 1) {
            performanceGrade = 'A'; // 100ms以下、メモリ1MB以下
        }
        else if (duration < 500 && memoryDelta < 5) {
            performanceGrade = 'B'; // 500ms以下、メモリ5MB以下
        }
        else if (duration < 1000 && memoryDelta < 10) {
            performanceGrade = 'C'; // 1秒以下、メモリ10MB以下
        }
        else {
            performanceGrade = 'F'; // 要件超過
        }
        return {
            metrics,
            stats,
            performanceGrade
        };
    }
}
exports.MetricsGenerationMonitor = MetricsGenerationMonitor;
// 型安全なメトリクス検証（CLAUDE.md: Type-Driven Development）
function validateMetricDefinition(metric) {
    const errors = [];
    // 必須フィールド検証
    if (!metric.metric_name || typeof metric.metric_name !== 'string') {
        errors.push('metric_name must be a non-empty string');
    }
    if (!metric.namespace || typeof metric.namespace !== 'string') {
        errors.push('namespace must be a non-empty string');
    }
    // しきい値妥当性検証（カスタムマッチャーと同じロジック）
    const threshold = metric.recommended_threshold;
    if (threshold.warning >= threshold.critical) {
        errors.push(`Invalid threshold: warning(${threshold.warning}) >= critical(${threshold.critical})`);
    }
    if (threshold.warning <= 0 || threshold.critical <= 0) {
        errors.push('Thresholds must be positive numbers');
    }
    // 評価期間検証
    const validPeriods = [60, 300, 900, 3600]; // CloudWatch標準期間
    if (!validPeriods.includes(metric.evaluation_period)) {
        errors.push(`Invalid evaluation_period: ${metric.evaluation_period}. Valid: ${validPeriods.join(', ')}`);
    }
    return {
        isValid: errors.length === 0,
        errors
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvc3JjL2dlbmVyYXRvcnMvYmFzZS5nZW5lcmF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHdFQUF3RTs7O0FBbVB4RSw0REFtQ0M7QUFqUkQsMENBQXFEO0FBRXJELDhDQUE4QztBQUM5QyxNQUFzQixvQkFBb0I7SUFFbEI7SUFBdEIsWUFBc0IsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7SUFBRyxDQUFDO0lBT3pDLGdEQUFnRDtJQUNoRCxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQWdDO1FBQzdDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVwQyxJQUFJLENBQUM7WUFDSCxhQUFhO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWhDLGNBQWM7WUFDZCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU5RCxvQkFBb0I7WUFDcEIsTUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQzdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQzdDLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBRS9DLDZCQUE2QjtZQUM3QixJQUFJLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDNUcsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsT0FBTyxDQUFDLE1BQU0sZ0JBQWdCLElBQUksQ0FB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UyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7SUFDckcsQ0FBQztJQUVELElBQUksU0FBUyxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksU0FBUyxDQUFDLFFBQVEsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN0RCxNQUFNLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFNBQVM7SUFDVCxNQUFNLFlBQVksR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsaUJBQWlCO0lBQzVELElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7UUFDckQsTUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsTUFBTSxDQUFDLGlCQUFpQixZQUFZLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQztRQUM1QixNQUFNO0tBQ1AsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvc3JjL2dlbmVyYXRvcnMvYmFzZS5nZW5lcmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ0xBVURFLm1k5rqW5ougQmFzZU1ldHJpY3NHZW5lcmF0b3LvvIhTT0xJROaKveixoeWMluWOn+WJhyArIFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG5cbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UgfSBmcm9tICcuLi90eXBlcy9jbG91ZGZvcm1hdGlvbic7XG5pbXBvcnQgeyBNZXRyaWNEZWZpbml0aW9uLCBNZXRyaWNDb25maWcsIElNZXRyaWNzR2VuZXJhdG9yIH0gZnJvbSAnLi4vdHlwZXMvbWV0cmljcyc7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IGNyZWF0ZVJlc291cmNlRXJyb3IgfSBmcm9tICcuLi91dGlscy9lcnJvcic7XG5cbi8vIFNPTElE5Y6f5YmHOiDmir3osaHljJbjgavjgojjgovmi6HlvLXmgKfnorrkv53vvIhPcGVuL0Nsb3NlZCBQcmluY2lwbGXvvIlcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCYXNlTWV0cmljc0dlbmVyYXRvciBpbXBsZW1lbnRzIElNZXRyaWNzR2VuZXJhdG9yIHtcbiAgXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBsb2dnZXI6IElMb2dnZXIpIHt9XG5cbiAgLy8g5oq96LGh44Oh44K944OD44OJ576k77yIU09MSUQ6IEludGVyZmFjZSBTZWdyZWdhdGlvbu+8iVxuICBhYnN0cmFjdCBnZXRTdXBwb3J0ZWRUeXBlcygpOiBzdHJpbmdbXTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldE1ldHJpY3NDb25maWcocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBNZXRyaWNDb25maWdbXTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldFJlc291cmNlU2NhbGUocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBudW1iZXI7XG5cbiAgLy8g44Oh44Kk44Oz55Sf5oiQ44Oh44K944OD44OJ77yIQ0xBVURFLm1kOiBUeXBlLURyaXZlbiBEZXZlbG9wbWVudO+8iVxuICBhc3luYyBnZW5lcmF0ZShyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IFByb21pc2U8TWV0cmljRGVmaW5pdGlvbltdPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIOWei+WuieWFqOOBquODquOCveODvOOCueaknOiovFxuICAgICAgdGhpcy52YWxpZGF0ZVJlc291cmNlKHJlc291cmNlKTtcbiAgICAgIFxuICAgICAgLy8g6YGp55So5Y+v6IO944Oh44OI44Oq44Kv44K55rG65a6aXG4gICAgICBjb25zdCBhcHBsaWNhYmxlQ29uZmlncyA9IHRoaXMuZ2V0QXBwbGljYWJsZU1ldHJpY3MocmVzb3VyY2UpO1xuICAgICAgXG4gICAgICAvLyDjg6Hjg4jjg6rjgq/jgrnlrprnvqnnlJ/miJDvvIjlnovlronlhajmgKfph43oppbvvIlcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBhcHBsaWNhYmxlQ29uZmlncy5tYXAoY29uZmlnID0+IFxuICAgICAgICB0aGlzLmJ1aWxkTWV0cmljRGVmaW5pdGlvbihyZXNvdXJjZSwgY29uZmlnKVxuICAgICAgKTtcblxuICAgICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIFxuICAgICAgLy8g44OR44OV44Kp44O844Oe44Oz44K555uj6KaW77yIQ0xBVURFLm1kOiDmgKfog73opoHku7bvvIlcbiAgICAgIGlmIChkdXJhdGlvbiA+IDEwMDApIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgTWV0cmljcyBnZW5lcmF0aW9uIHNsb3c6ICR7ZHVyYXRpb24udG9GaXhlZCgwKX1tcyBmb3IgJHt0aGlzLmdldFJlc291cmNlSWQocmVzb3VyY2UpfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEdlbmVyYXRlZCAke21ldHJpY3MubGVuZ3RofSBtZXRyaWNzIGZvciAke3RoaXMuZ2V0UmVzb3VyY2VJZChyZXNvdXJjZSl9IGluICR7ZHVyYXRpb24udG9GaXhlZCgxKX1tc2ApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbWV0cmljcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgcmVzb3VyY2VJZCA9IHRoaXMuZ2V0UmVzb3VyY2VJZChyZXNvdXJjZSk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGdlbmVyYXRlIG1ldHJpY3MgZm9yICR7cmVzb3VyY2VJZH1gLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICB0aHJvdyBjcmVhdGVSZXNvdXJjZUVycm9yKFxuICAgICAgICBgTWV0cmljcyBnZW5lcmF0aW9uIGZhaWxlZCBmb3IgJHtyZXNvdXJjZUlkfTogJHsoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2V9YCxcbiAgICAgICAgeyByZXNvdXJjZVR5cGU6IHJlc291cmNlLlR5cGUsIG9yaWdpbmFsRXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIOmBqeeUqOWPr+iDveODoeODiOODquOCr+OCueWIpOWumu+8iFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG4gIHByaXZhdGUgZ2V0QXBwbGljYWJsZU1ldHJpY3MocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBNZXRyaWNDb25maWdbXSB7XG4gICAgY29uc3QgYWxsQ29uZmlncyA9IHRoaXMuZ2V0TWV0cmljc0NvbmZpZyhyZXNvdXJjZSk7XG4gICAgXG4gICAgcmV0dXJuIGFsbENvbmZpZ3MuZmlsdGVyKGNvbmZpZyA9PiB7XG4gICAgICBpZiAoIWNvbmZpZy5hcHBsaWNhYmxlV2hlbikge1xuICAgICAgICByZXR1cm4gdHJ1ZTsgLy8g5p2h5Lu244Gq44GX44Gv5YWo44Gm6YGp55SoXG4gICAgICB9XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBjb25maWcuYXBwbGljYWJsZVdoZW4ocmVzb3VyY2UpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgRmFpbGVkIHRvIGV2YWx1YXRlIG1ldHJpYyBjb25kaXRpb246ICR7Y29uZmlnLm5hbWV9YCwgZXJyb3IgYXMgRXJyb3IpO1xuICAgICAgICByZXR1cm4gZmFsc2U7IC8vIOipleS+oeWkseaVl+aZguOBr+mBqeeUqOOBl+OBquOBhFxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8g44Oh44OI44Oq44Kv44K55a6a576p5qeL56+J77yI5Z6L5a6J5YWo5oCn6YeN6KaW77yJXG4gIHByaXZhdGUgYnVpbGRNZXRyaWNEZWZpbml0aW9uKFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlLFxuICAgIGNvbmZpZzogTWV0cmljQ29uZmlnXG4gICk6IE1ldHJpY0RlZmluaXRpb24ge1xuICAgIGNvbnN0IHRocmVzaG9sZCA9IHRoaXMuY2FsY3VsYXRlVGhyZXNob2xkKHJlc291cmNlLCBjb25maWcpO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBtZXRyaWNfbmFtZTogY29uZmlnLm5hbWUsXG4gICAgICBuYW1lc3BhY2U6IGNvbmZpZy5uYW1lc3BhY2UsXG4gICAgICB1bml0OiBjb25maWcudW5pdCxcbiAgICAgIGRlc2NyaXB0aW9uOiBjb25maWcuZGVzY3JpcHRpb24sXG4gICAgICBzdGF0aXN0aWM6IGNvbmZpZy5zdGF0aXN0aWMsXG4gICAgICByZWNvbW1lbmRlZF90aHJlc2hvbGQ6IHRocmVzaG9sZCxcbiAgICAgIGV2YWx1YXRpb25fcGVyaW9kOiBjb25maWcuZXZhbHVhdGlvblBlcmlvZCxcbiAgICAgIGNhdGVnb3J5OiBjb25maWcuY2F0ZWdvcnksXG4gICAgICBpbXBvcnRhbmNlOiBjb25maWcuaW1wb3J0YW5jZSxcbiAgICAgIGRpbWVuc2lvbnM6IHRoaXMuYnVpbGREaW1lbnNpb25zKHJlc291cmNlLCBjb25maWcpXG4gICAgfTtcbiAgfVxuXG4gIC8vIOWLleeahOOBl+OBjeOBhOWApOioiOeul++8iENMQVVERS5tZDog44Ki44Or44K044Oq44K644Og5a6f6KOF77yJXG4gIHByaXZhdGUgY2FsY3VsYXRlVGhyZXNob2xkKFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlLFxuICAgIGNvbmZpZzogTWV0cmljQ29uZmlnXG4gICk6IHsgd2FybmluZzogbnVtYmVyOyBjcml0aWNhbDogbnVtYmVyIH0ge1xuICAgIC8vIOODquOCveODvOOCueOCueOCseODvOODq+S/guaVsOWPluW+l1xuICAgIGNvbnN0IHNjYWxlID0gdGhpcy5nZXRSZXNvdXJjZVNjYWxlKHJlc291cmNlKTtcbiAgICBjb25zdCBiYXNlID0gY29uZmlnLnRocmVzaG9sZC5iYXNlO1xuICAgIFxuICAgIC8vIOWLleeahOioiOeul++8iENMQVVERS5tZDogVHlwZS1Ecml2ZW4gRGV2ZWxvcG1lbnTvvIlcbiAgICBjb25zdCB3YXJuaW5nID0gTWF0aC5yb3VuZChiYXNlICogc2NhbGUgKiBjb25maWcudGhyZXNob2xkLndhcm5pbmdNdWx0aXBsaWVyKTtcbiAgICBjb25zdCBjcml0aWNhbCA9IE1hdGgucm91bmQoYmFzZSAqIHNjYWxlICogY29uZmlnLnRocmVzaG9sZC5jcml0aWNhbE11bHRpcGxpZXIpO1xuICAgIFxuICAgIC8vIOOBl+OBjeOBhOWApOWmpeW9k+aAp+aknOiovO+8iHdhcm5pbmcgPCBjcml0aWNhbOOAgeacgOWwj+WApOS/neiovO+8iVxuICAgIGlmICh3YXJuaW5nID49IGNyaXRpY2FsIHx8IHdhcm5pbmcgPT09IDApIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYEludmFsaWQgdGhyZXNob2xkIGNhbGN1bGF0aW9uOiB3YXJuaW5nPSR7d2FybmluZ30gPj0gY3JpdGljYWw9JHtjcml0aWNhbH0gZm9yICR7Y29uZmlnLm5hbWV9YCk7XG4gICAgICBcbiAgICAgIC8vIOacgOWwj+WApOS/neiovO+8iENMQVVERS5tZDog5a6f55So5oCn6YeN6KaW77yJXG4gICAgICBjb25zdCBjb3JyZWN0ZWRXYXJuaW5nID0gTWF0aC5tYXgod2FybmluZywgMSk7XG4gICAgICBjb25zdCBjb3JyZWN0ZWRDcml0aWNhbCA9IE1hdGgubWF4KGNyaXRpY2FsLCBjb3JyZWN0ZWRXYXJuaW5nICsgMSk7XG4gICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmluZm8oYEF1dG8tY29ycmVjdGVkIHRocmVzaG9sZHM6IHdhcm5pbmc9JHt3YXJuaW5nfeKGkiR7Y29ycmVjdGVkV2FybmluZ30sIGNyaXRpY2FsPSR7Y3JpdGljYWx94oaSJHtjb3JyZWN0ZWRDcml0aWNhbH1gKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgd2FybmluZzogY29ycmVjdGVkV2FybmluZyxcbiAgICAgICAgY3JpdGljYWw6IGNvcnJlY3RlZENyaXRpY2FsXG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4geyB3YXJuaW5nLCBjcml0aWNhbCB9O1xuICB9XG5cbiAgLy8gQ2xvdWRXYXRjaOODh+OCo+ODoeODs+OCt+ODp+ODs+ani+evie+8iEFXU+S7leanmOa6luaLoO+8iVxuICBwcml2YXRlIGJ1aWxkRGltZW5zaW9ucyhcbiAgICByZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSxcbiAgICBfY29uZmlnOiBNZXRyaWNDb25maWcgLy8g5bCG5p2l5ouh5by155So77yI54++5Zyo5pyq5L2/55So77yJXG4gICk6IEFycmF5PHsgbmFtZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH0+IHtcbiAgICBjb25zdCByZXNvdXJjZUlkID0gdGhpcy5nZXRSZXNvdXJjZUlkKHJlc291cmNlKTtcbiAgICBjb25zdCBwcmltYXJ5RGltZW5zaW9uID0gdGhpcy5nZXRQcmltYXJ5RGltZW5zaW9uTmFtZShyZXNvdXJjZS5UeXBlKTtcbiAgICBcbiAgICByZXR1cm4gW1xuICAgICAge1xuICAgICAgICBuYW1lOiBwcmltYXJ5RGltZW5zaW9uLFxuICAgICAgICB2YWx1ZTogcmVzb3VyY2VJZFxuICAgICAgfVxuICAgIF07XG4gIH1cblxuICAvLyDjg6rjgr3jg7zjgrnjgr/jgqTjg5fliKXjg5fjg6njgqTjg57jg6rjg4fjgqPjg6Hjg7Pjgrfjg6fjg7PvvIhBV1MgQ2xvdWRXYXRjaOS7leanmO+8iVxuICBwcml2YXRlIGdldFByaW1hcnlEaW1lbnNpb25OYW1lKHJlc291cmNlVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBkaW1lbnNpb25NYXA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAnQVdTOjpSRFM6OkRCSW5zdGFuY2UnOiAnREJJbnN0YW5jZUlkZW50aWZpZXInLFxuICAgICAgJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbic6ICdGdW5jdGlvbk5hbWUnLFxuICAgICAgJ0FXUzo6U2VydmVybGVzczo6RnVuY3Rpb24nOiAnRnVuY3Rpb25OYW1lJyxcbiAgICAgICdBV1M6OkVDUzo6U2VydmljZSc6ICdTZXJ2aWNlTmFtZScsXG4gICAgICAnQVdTOjpFbGFzdGljTG9hZEJhbGFuY2luZ1YyOjpMb2FkQmFsYW5jZXInOiAnTG9hZEJhbGFuY2VyJyxcbiAgICAgICdBV1M6OkR5bmFtb0RCOjpUYWJsZSc6ICdUYWJsZU5hbWUnLFxuICAgICAgJ0FXUzo6QXBpR2F0ZXdheTo6UmVzdEFwaSc6ICdBcGlOYW1lJyxcbiAgICAgICdBV1M6OlNlcnZlcmxlc3M6OkFwaSc6ICdBcGlOYW1lJ1xuICAgIH07XG4gICAgXG4gICAgcmV0dXJuIGRpbWVuc2lvbk1hcFtyZXNvdXJjZVR5cGVdID8/ICdSZXNvdXJjZUlkJztcbiAgfVxuXG4gIC8vIOWei+WuieWFqOOBquODquOCveODvOOCuUlE5Y+W5b6XXG4gIHByaXZhdGUgZ2V0UmVzb3VyY2VJZChyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IHN0cmluZyB7XG4gICAgLy8gTG9naWNhbElk44OX44Ot44OR44OG44Kj44Gu5Z6L5a6J5YWo5Y+W5b6XXG4gICAgY29uc3QgcmVzb3VyY2VXaXRoSWQgPSByZXNvdXJjZSBhcyBDbG91ZEZvcm1hdGlvblJlc291cmNlICYgeyBMb2dpY2FsSWQ/OiBzdHJpbmcgfTtcbiAgICByZXR1cm4gcmVzb3VyY2VXaXRoSWQuTG9naWNhbElkID8/ICdVbmtub3duUmVzb3VyY2UnO1xuICB9XG5cbiAgLy8g44Oq44K944O844K55Z+65pys5qSc6Ki877yI5Z6L5a6J5YWo5oCn77yJXG4gIHByaXZhdGUgdmFsaWRhdGVSZXNvdXJjZShyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IHZvaWQge1xuICAgIGlmICghcmVzb3VyY2UuVHlwZSB8fCB0eXBlb2YgcmVzb3VyY2UuVHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IGNyZWF0ZVJlc291cmNlRXJyb3IoXG4gICAgICAgICdSZXNvdXJjZSBtdXN0IGhhdmUgYSB2YWxpZCBUeXBlIHByb3BlcnR5JyxcbiAgICAgICAgeyByZXNvdXJjZURhdGE6IEpTT04uc3RyaW5naWZ5KHJlc291cmNlKSB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5nZXRTdXBwb3J0ZWRUeXBlcygpLmluY2x1ZGVzKHJlc291cmNlLlR5cGUpKSB7XG4gICAgICB0aHJvdyBjcmVhdGVSZXNvdXJjZUVycm9yKFxuICAgICAgICBgVW5zdXBwb3J0ZWQgcmVzb3VyY2UgdHlwZTogJHtyZXNvdXJjZS5UeXBlfWAsXG4gICAgICAgIHsgXG4gICAgICAgICAgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5UeXBlLFxuICAgICAgICAgIHN1cHBvcnRlZFR5cGVzOiB0aGlzLmdldFN1cHBvcnRlZFR5cGVzKClcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuLy8g44Oh44OI44Oq44Kv44K555Sf5oiQ57Wx6KiI5oOF5aCx77yIQ0xBVURFLm1kOiDnm6Poppbjg7vjg4fjg5Djg4PjgrDmlK/mj7TvvIlcbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJhdGlvblN0YXRzIHtcbiAgcmVzb3VyY2VUeXBlOiBzdHJpbmc7XG4gIG1ldHJpY3NHZW5lcmF0ZWQ6IG51bWJlcjtcbiAgZ2VuZXJhdGlvblRpbWVNczogbnVtYmVyO1xuICBhdmVyYWdlVGhyZXNob2xkV2FybmluZzogbnVtYmVyO1xuICBhdmVyYWdlVGhyZXNob2xkQ3JpdGljYWw6IG51bWJlcjtcbn1cblxuLy8g44OR44OV44Kp44O844Oe44Oz44K55ris5a6a44OY44Or44OR44O877yIQ0xBVURFLm1kOiDljZjkuIDosqzku7vliIbpm6LvvIlcbmV4cG9ydCBjbGFzcyBNZXRyaWNzR2VuZXJhdGlvbk1vbml0b3Ige1xuICBcbiAgc3RhdGljIGFzeW5jIG1lYXN1cmVHZW5lcmF0aW9uUGVyZm9ybWFuY2U8VCBleHRlbmRzIEJhc2VNZXRyaWNzR2VuZXJhdG9yPihcbiAgICBnZW5lcmF0b3I6IFQsXG4gICAgcmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2VcbiAgKTogUHJvbWlzZTx7XG4gICAgbWV0cmljczogTWV0cmljRGVmaW5pdGlvbltdO1xuICAgIHN0YXRzOiBHZW5lcmF0aW9uU3RhdHM7XG4gICAgcGVyZm9ybWFuY2VHcmFkZTogJ0EnIHwgJ0InIHwgJ0MnIHwgJ0YnO1xuICB9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgY29uc3QgbWVtb3J5QmVmb3JlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgIFxuICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCBnZW5lcmF0b3IuZ2VuZXJhdGUocmVzb3VyY2UpO1xuICAgIFxuICAgIGNvbnN0IGR1cmF0aW9uID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG4gICAgY29uc3QgbWVtb3J5QWZ0ZXIgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XG4gICAgY29uc3QgbWVtb3J5RGVsdGEgPSAobWVtb3J5QWZ0ZXIgLSBtZW1vcnlCZWZvcmUpIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAvLyDntbHoqIjmg4XloLHoqIjnrpdcbiAgICBjb25zdCBzdGF0czogR2VuZXJhdGlvblN0YXRzID0ge1xuICAgICAgcmVzb3VyY2VUeXBlOiByZXNvdXJjZS5UeXBlLFxuICAgICAgbWV0cmljc0dlbmVyYXRlZDogbWV0cmljcy5sZW5ndGgsXG4gICAgICBnZW5lcmF0aW9uVGltZU1zOiBNYXRoLnJvdW5kKGR1cmF0aW9uKSxcbiAgICAgIGF2ZXJhZ2VUaHJlc2hvbGRXYXJuaW5nOiBtZXRyaWNzLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyBtLnJlY29tbWVuZGVkX3RocmVzaG9sZC53YXJuaW5nLCAwKSAvIG1ldHJpY3MubGVuZ3RoLFxuICAgICAgYXZlcmFnZVRocmVzaG9sZENyaXRpY2FsOiBtZXRyaWNzLnJlZHVjZSgoc3VtLCBtKSA9PiBzdW0gKyBtLnJlY29tbWVuZGVkX3RocmVzaG9sZC5jcml0aWNhbCwgMCkgLyBtZXRyaWNzLmxlbmd0aFxuICAgIH07XG5cbiAgICAvLyDjg5Hjg5Xjgqnjg7zjg57jg7PjgrnoqZXkvqFcbiAgICBsZXQgcGVyZm9ybWFuY2VHcmFkZTogJ0EnIHwgJ0InIHwgJ0MnIHwgJ0YnO1xuICAgIGlmIChkdXJhdGlvbiA8IDEwMCAmJiBtZW1vcnlEZWx0YSA8IDEpIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnQSc7IC8vIDEwMG1z5Lul5LiL44CB44Oh44Oi44OqMU1C5Lul5LiLXG4gICAgfSBlbHNlIGlmIChkdXJhdGlvbiA8IDUwMCAmJiBtZW1vcnlEZWx0YSA8IDUpIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnQic7IC8vIDUwMG1z5Lul5LiL44CB44Oh44Oi44OqNU1C5Lul5LiLXG4gICAgfSBlbHNlIGlmIChkdXJhdGlvbiA8IDEwMDAgJiYgbWVtb3J5RGVsdGEgPCAxMCkge1xuICAgICAgcGVyZm9ybWFuY2VHcmFkZSA9ICdDJzsgLy8gMeenkuS7peS4i+OAgeODoeODouODqjEwTULku6XkuItcbiAgICB9IGVsc2Uge1xuICAgICAgcGVyZm9ybWFuY2VHcmFkZSA9ICdGJzsgLy8g6KaB5Lu26LaF6YGOXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldHJpY3MsXG4gICAgICBzdGF0cyxcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGVcbiAgICB9O1xuICB9XG59XG5cbi8vIOWei+WuieWFqOOBquODoeODiOODquOCr+OCueaknOiovO+8iENMQVVERS5tZDogVHlwZS1Ecml2ZW4gRGV2ZWxvcG1lbnTvvIlcbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZU1ldHJpY0RlZmluaXRpb24obWV0cmljOiBNZXRyaWNEZWZpbml0aW9uKToge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xufSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAvLyDlv4XpoIjjg5XjgqPjg7zjg6vjg4nmpJzoqLxcbiAgaWYgKCFtZXRyaWMubWV0cmljX25hbWUgfHwgdHlwZW9mIG1ldHJpYy5tZXRyaWNfbmFtZSAhPT0gJ3N0cmluZycpIHtcbiAgICBlcnJvcnMucHVzaCgnbWV0cmljX25hbWUgbXVzdCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcnKTtcbiAgfVxuICBcbiAgaWYgKCFtZXRyaWMubmFtZXNwYWNlIHx8IHR5cGVvZiBtZXRyaWMubmFtZXNwYWNlICE9PSAnc3RyaW5nJykge1xuICAgIGVycm9ycy5wdXNoKCduYW1lc3BhY2UgbXVzdCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcnKTtcbiAgfVxuXG4gIC8vIOOBl+OBjeOBhOWApOWmpeW9k+aAp+aknOiovO+8iOOCq+OCueOCv+ODoOODnuODg+ODgeODo+ODvOOBqOWQjOOBmOODreOCuOODg+OCr++8iVxuICBjb25zdCB0aHJlc2hvbGQgPSBtZXRyaWMucmVjb21tZW5kZWRfdGhyZXNob2xkO1xuICBpZiAodGhyZXNob2xkLndhcm5pbmcgPj0gdGhyZXNob2xkLmNyaXRpY2FsKSB7XG4gICAgZXJyb3JzLnB1c2goYEludmFsaWQgdGhyZXNob2xkOiB3YXJuaW5nKCR7dGhyZXNob2xkLndhcm5pbmd9KSA+PSBjcml0aWNhbCgke3RocmVzaG9sZC5jcml0aWNhbH0pYCk7XG4gIH1cblxuICBpZiAodGhyZXNob2xkLndhcm5pbmcgPD0gMCB8fCB0aHJlc2hvbGQuY3JpdGljYWwgPD0gMCkge1xuICAgIGVycm9ycy5wdXNoKCdUaHJlc2hvbGRzIG11c3QgYmUgcG9zaXRpdmUgbnVtYmVycycpO1xuICB9XG5cbiAgLy8g6KmV5L6h5pyf6ZaT5qSc6Ki8XG4gIGNvbnN0IHZhbGlkUGVyaW9kcyA9IFs2MCwgMzAwLCA5MDAsIDM2MDBdOyAvLyBDbG91ZFdhdGNo5qiZ5rqW5pyf6ZaTXG4gIGlmICghdmFsaWRQZXJpb2RzLmluY2x1ZGVzKG1ldHJpYy5ldmFsdWF0aW9uX3BlcmlvZCkpIHtcbiAgICBlcnJvcnMucHVzaChgSW52YWxpZCBldmFsdWF0aW9uX3BlcmlvZDogJHttZXRyaWMuZXZhbHVhdGlvbl9wZXJpb2R9LiBWYWxpZDogJHt2YWxpZFBlcmlvZHMuam9pbignLCAnKX1gKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICBlcnJvcnNcbiAgfTtcbn0iXSwidmVyc2lvbiI6M30=