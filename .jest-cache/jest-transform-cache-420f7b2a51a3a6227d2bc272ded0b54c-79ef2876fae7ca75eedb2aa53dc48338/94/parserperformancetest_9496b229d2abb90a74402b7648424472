ead2811dfbc2c21aeb14aa3cfb006f48
"use strict";
// CLAUDE.md準拠TemplateParserパフォーマンス最適化テスト（BLUE段階）
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const parser_1 = require("../../../src/core/parser");
const fs_1 = require("fs");
const path_1 = __importDefault(require("path"));
const os_1 = require("os");
describe('TemplateParser最適化（CLAUDE.md: BLUE段階）', () => {
    let tempDir;
    beforeAll(() => {
        tempDir = path_1.default.join((0, os_1.tmpdir)(), 'aws-cloud-supporter-perf-test');
        try {
            (0, fs_1.mkdirSync)(tempDir, { recursive: true });
        }
        catch {
            // 既存の場合は無視
        }
    });
    // FileReaderユーティリティクラスのテスト（UNIX Philosophy: 分離）
    it('should provide efficient file reading utilities', async () => {
        // テストファイル作成
        const testContent = 'AWSTemplateFormatVersion: "2010-09-09"\nResources:\n  Test:\n    Type: AWS::S3::Bucket';
        const testPath = path_1.default.join(tempDir, 'test-file-reader.yaml');
        (0, fs_1.writeFileSync)(testPath, testContent, 'utf8');
        // FileReader.readText テスト
        const content = await parser_1.FileReader.readText(testPath);
        expect(content).toBe(testContent);
        // FileReader.getStats テスト
        const stats = await parser_1.FileReader.getStats(testPath);
        expect(stats.isFile).toBe(true);
        expect(stats.size).toBeGreaterThan(0);
    });
    // ファイル形式判定関数テスト（型安全性）
    it('should accurately detect file formats', () => {
        const { isJSONFile, isYAMLFile, isSupportedTemplateFile } = require('../../../src/core/parser');
        expect(isJSONFile('template.json')).toBe(true);
        expect(isJSONFile('template.JSON')).toBe(true); // 大文字小文字対応
        expect(isJSONFile('template.yaml')).toBe(false);
        expect(isYAMLFile('template.yaml')).toBe(true);
        expect(isYAMLFile('template.yml')).toBe(true);
        expect(isYAMLFile('template.YAML')).toBe(true); // 大文字小文字対応
        expect(isYAMLFile('template.json')).toBe(false);
        expect(isSupportedTemplateFile('template.json')).toBe(true);
        expect(isSupportedTemplateFile('template.yaml')).toBe(true);
        expect(isSupportedTemplateFile('template.txt')).toBe(false);
    });
    // 型安全性の向上テスト
    it('should demonstrate improved type safety', async () => {
        const parser = new parser_1.TemplateParser();
        const testTemplate = `
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  TestDB:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: postgresql
      DBInstanceClass: db.r5.large
`;
        const testPath = path_1.default.join(tempDir, 'type-safety-test.yaml');
        (0, fs_1.writeFileSync)(testPath, testTemplate, 'utf8');
        const template = await parser.parse(testPath);
        // TypeScript型推論の活用
        expect(template.AWSTemplateFormatVersion).toBe('2010-09-09');
        // リソース型の型安全アクセス
        const testDB = template.Resources.TestDB;
        expect(testDB.Type).toBe('AWS::RDS::DBInstance');
        // Propertiesは型安全（unknownだが構造化アクセス可能）
        if (testDB.Properties && typeof testDB.Properties === 'object') {
            const props = testDB.Properties;
            expect(props.Engine).toBe('postgresql');
            expect(props.DBInstanceClass).toBe('db.r5.large');
        }
    });
    // エラーハンドリングの最適化テスト
    it('should provide optimized error handling', async () => {
        const parser = new parser_1.TemplateParser();
        // Resourcesセクションが無い場合
        const noResourcesTemplate = `
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Template without Resources section'
`;
        const noResourcesPath = path_1.default.join(tempDir, 'no-resources.yaml');
        (0, fs_1.writeFileSync)(noResourcesPath, noResourcesTemplate, 'utf8');
        try {
            await parser.parse(noResourcesPath);
        }
        catch (error) {
            expect(error.type).toBe('PARSE_ERROR');
            expect(error.message).toContain('Resources');
            expect(error.filePath).toBe(noResourcesPath);
            const structured = error.toStructuredOutput();
            expect(structured.timestamp).toBeDefined();
        }
    });
    // 大規模テンプレートの効率的処理
    it('should handle moderately large templates efficiently', async () => {
        const parser = new parser_1.TemplateParser();
        // 中規模テンプレート（1000リソース程度）
        const mediumTemplate = {
            AWSTemplateFormatVersion: "2010-09-09",
            Description: "Medium size template",
            Resources: {}
        };
        for (let i = 0; i < 1000; i++) {
            mediumTemplate.Resources[`TestBucket${i}`] = {
                Type: "AWS::S3::Bucket",
                Properties: {
                    BucketName: `test-bucket-${i}`
                }
            };
        }
        const mediumPath = path_1.default.join(tempDir, 'medium-template.json');
        (0, fs_1.writeFileSync)(mediumPath, JSON.stringify(mediumTemplate, null, 2), 'utf8');
        const startTime = performance.now();
        const template = await parser.parse(mediumPath);
        const duration = performance.now() - startTime;
        expect(duration).toBeLessThan(2000); // 2秒以内
        expect(Object.keys(template.Resources)).toHaveLength(1000);
    });
    // インターフェース型安全性テスト（CLAUDE.md: Interface Segregation）
    it('should implement ITemplateParser interface correctly', () => {
        const parser = new parser_1.TemplateParser();
        // インターフェース実装確認
        expect(typeof parser.parse).toBe('function');
        expect(parser.parse.length).toBe(1); // 引数1個
        // SOLID Interface Segregation原則確認
        // TemplateParserは解析のみに特化
        const parserMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(parser));
        const publicMethods = parserMethods.filter(method => !method.startsWith('_') && method !== 'constructor');
        expect(publicMethods).toContain('parse');
        expect(publicMethods.length).toBe(1); // parseメソッドのみpublic
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvdGVzdHMvdW5pdC9jb3JlL3BhcnNlci1wZXJmb3JtYW5jZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQSxpREFBaUQ7Ozs7O0FBRWpELHFEQUFzRTtBQUN0RSwyQkFBOEM7QUFDOUMsZ0RBQXdCO0FBQ3hCLDJCQUE0QjtBQUU1QixRQUFRLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO0lBQ3BELElBQUksT0FBZSxDQUFDO0lBRXBCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixPQUFPLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFBLFdBQU0sR0FBRSxFQUFFLCtCQUErQixDQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDO1lBQ0gsSUFBQSxjQUFTLEVBQUMsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLFdBQVc7UUFDYixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxnREFBZ0Q7SUFDaEQsRUFBRSxDQUFDLGlEQUFpRCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQy9ELFlBQVk7UUFDWixNQUFNLFdBQVcsR0FBRyx3RkFBd0YsQ0FBQztRQUM3RyxNQUFNLFFBQVEsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBQzdELElBQUEsa0JBQWEsRUFBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTdDLDBCQUEwQjtRQUMxQixNQUFNLE9BQU8sR0FBRyxNQUFNLG1CQUFVLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFbEMsMEJBQTBCO1FBQzFCLE1BQU0sS0FBSyxHQUFHLE1BQU0sbUJBQVUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7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RXBDLGVBQWU7UUFDZixNQUFNLENBQUMsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFFNUMsa0NBQWtDO1FBQ2xDLHlCQUF5QjtRQUN6QixNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2hGLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxLQUFLLGFBQWEsQ0FBQyxDQUFDO1FBRTFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7SUFDNUQsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9reW9oZWkvYXdzX2Nsb3VkX3N1cHBvcnRlci90ZXN0cy91bml0L2NvcmUvcGFyc2VyLXBlcmZvcm1hbmNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ0xBVURFLm1k5rqW5ougVGVtcGxhdGVQYXJzZXLjg5Hjg5Xjgqnjg7zjg57jg7PjgrnmnIDpganljJbjg4bjgrnjg4jvvIhCTFVF5q616ZqO77yJXG5cbmltcG9ydCB7IFRlbXBsYXRlUGFyc2VyLCBGaWxlUmVhZGVyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2NvcmUvcGFyc2VyJztcbmltcG9ydCB7IHdyaXRlRmlsZVN5bmMsIG1rZGlyU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgdG1wZGlyIH0gZnJvbSAnb3MnO1xuXG5kZXNjcmliZSgnVGVtcGxhdGVQYXJzZXLmnIDpganljJbvvIhDTEFVREUubWQ6IEJMVUXmrrXpmo7vvIknLCAoKSA9PiB7XG4gIGxldCB0ZW1wRGlyOiBzdHJpbmc7XG5cbiAgYmVmb3JlQWxsKCgpID0+IHtcbiAgICB0ZW1wRGlyID0gcGF0aC5qb2luKHRtcGRpcigpLCAnYXdzLWNsb3VkLXN1cHBvcnRlci1wZXJmLXRlc3QnKTtcbiAgICB0cnkge1xuICAgICAgbWtkaXJTeW5jKHRlbXBEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8g5pei5a2Y44Gu5aC05ZCI44Gv54Sh6KaWXG4gICAgfVxuICB9KTtcblxuICAvLyBGaWxlUmVhZGVy44Om44O844OG44Kj44Oq44OG44Kj44Kv44Op44K544Gu44OG44K544OI77yIVU5JWCBQaGlsb3NvcGh5OiDliIbpm6LvvIlcbiAgaXQoJ3Nob3VsZCBwcm92aWRlIGVmZmljaWVudCBmaWxlIHJlYWRpbmcgdXRpbGl0aWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIOODhuOCueODiOODleOCoeOCpOODq+S9nOaIkFxuICAgIGNvbnN0IHRlc3RDb250ZW50ID0gJ0FXU1RlbXBsYXRlRm9ybWF0VmVyc2lvbjogXCIyMDEwLTA5LTA5XCJcXG5SZXNvdXJjZXM6XFxuICBUZXN0OlxcbiAgICBUeXBlOiBBV1M6OlMzOjpCdWNrZXQnO1xuICAgIGNvbnN0IHRlc3RQYXRoID0gcGF0aC5qb2luKHRlbXBEaXIsICd0ZXN0LWZpbGUtcmVhZGVyLnlhbWwnKTtcbiAgICB3cml0ZUZpbGVTeW5jKHRlc3RQYXRoLCB0ZXN0Q29udGVudCwgJ3V0ZjgnKTtcblxuICAgIC8vIEZpbGVSZWFkZXIucmVhZFRleHQg44OG44K544OIXG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IEZpbGVSZWFkZXIucmVhZFRleHQodGVzdFBhdGgpO1xuICAgIGV4cGVjdChjb250ZW50KS50b0JlKHRlc3RDb250ZW50KTtcblxuICAgIC8vIEZpbGVSZWFkZXIuZ2V0U3RhdHMg44OG44K544OIXG4gICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBGaWxlUmVhZGVyLmdldFN0YXRzKHRlc3RQYXRoKTtcbiAgICBleHBlY3Qoc3RhdHMuaXNGaWxlKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChzdGF0cy5zaXplKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gIH0pO1xuXG4gIC8vIOODleOCoeOCpOODq+W9ouW8j+WIpOWumumWouaVsOODhuOCueODiO+8iOWei+WuieWFqOaAp++8iVxuICBpdCgnc2hvdWxkIGFjY3VyYXRlbHkgZGV0ZWN0IGZpbGUgZm9ybWF0cycsICgpID0+IHtcbiAgICBjb25zdCB7IGlzSlNPTkZpbGUsIGlzWUFNTEZpbGUsIGlzU3VwcG9ydGVkVGVtcGxhdGVGaWxlIH0gPSByZXF1aXJlKCcuLi8uLi8uLi9zcmMvY29yZS9wYXJzZXInKTtcblxuICAgIGV4cGVjdChpc0pTT05GaWxlKCd0ZW1wbGF0ZS5qc29uJykpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KGlzSlNPTkZpbGUoJ3RlbXBsYXRlLkpTT04nKSkudG9CZSh0cnVlKTsgLy8g5aSn5paH5a2X5bCP5paH5a2X5a++5b+cXG4gICAgZXhwZWN0KGlzSlNPTkZpbGUoJ3RlbXBsYXRlLnlhbWwnKSkudG9CZShmYWxzZSk7XG5cbiAgICBleHBlY3QoaXNZQU1MRmlsZSgndGVtcGxhdGUueWFtbCcpKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChpc1lBTUxGaWxlKCd0ZW1wbGF0ZS55bWwnKSkudG9CZSh0cnVlKTtcbiAgICBleHBlY3QoaXNZQU1MRmlsZSgndGVtcGxhdGUuWUFNTCcpKS50b0JlKHRydWUpOyAvLyDlpKfmloflrZflsI/mloflrZflr77lv5xcbiAgICBleHBlY3QoaXNZQU1MRmlsZSgndGVtcGxhdGUuanNvbicpKS50b0JlKGZhbHNlKTtcblxuICAgIGV4cGVjdChpc1N1cHBvcnRlZFRlbXBsYXRlRmlsZSgndGVtcGxhdGUuanNvbicpKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChpc1N1cHBvcnRlZFRlbXBsYXRlRmlsZSgndGVtcGxhdGUueWFtbCcpKS50b0JlKHRydWUpO1xuICAgIGV4cGVjdChpc1N1cHBvcnRlZFRlbXBsYXRlRmlsZSgndGVtcGxhdGUudHh0JykpLnRvQmUoZmFsc2UpO1xuICB9KTtcblxuICAvLyDlnovlronlhajmgKfjga7lkJHkuIrjg4bjgrnjg4hcbiAgaXQoJ3Nob3VsZCBkZW1vbnN0cmF0ZSBpbXByb3ZlZCB0eXBlIHNhZmV0eScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwYXJzZXIgPSBuZXcgVGVtcGxhdGVQYXJzZXIoKTtcbiAgICBjb25zdCB0ZXN0VGVtcGxhdGUgPSBgXG5BV1NUZW1wbGF0ZUZvcm1hdFZlcnNpb246ICcyMDEwLTA5LTA5J1xuUmVzb3VyY2VzOlxuICBUZXN0REI6XG4gICAgVHlwZTogQVdTOjpSRFM6OkRCSW5zdGFuY2VcbiAgICBQcm9wZXJ0aWVzOlxuICAgICAgRW5naW5lOiBwb3N0Z3Jlc3FsXG4gICAgICBEQkluc3RhbmNlQ2xhc3M6IGRiLnI1LmxhcmdlXG5gO1xuICAgIFxuICAgIGNvbnN0IHRlc3RQYXRoID0gcGF0aC5qb2luKHRlbXBEaXIsICd0eXBlLXNhZmV0eS10ZXN0LnlhbWwnKTtcbiAgICB3cml0ZUZpbGVTeW5jKHRlc3RQYXRoLCB0ZXN0VGVtcGxhdGUsICd1dGY4Jyk7XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHBhcnNlci5wYXJzZSh0ZXN0UGF0aCk7XG5cbiAgICAvLyBUeXBlU2NyaXB05Z6L5o6o6KuW44Gu5rS755SoXG4gICAgZXhwZWN0KHRlbXBsYXRlLkFXU1RlbXBsYXRlRm9ybWF0VmVyc2lvbikudG9CZSgnMjAxMC0wOS0wOScpO1xuICAgIFxuICAgIC8vIOODquOCveODvOOCueWei+OBruWei+WuieWFqOOCouOCr+OCu+OCuVxuICAgIGNvbnN0IHRlc3REQiA9IHRlbXBsYXRlLlJlc291cmNlcy5UZXN0REI7XG4gICAgZXhwZWN0KHRlc3REQi5UeXBlKS50b0JlKCdBV1M6OlJEUzo6REJJbnN0YW5jZScpO1xuICAgIFxuICAgIC8vIFByb3BlcnRpZXPjga/lnovlronlhajvvIh1bmtub3du44Gg44GM5qeL6YCg5YyW44Ki44Kv44K744K55Y+v6IO977yJXG4gICAgaWYgKHRlc3REQi5Qcm9wZXJ0aWVzICYmIHR5cGVvZiB0ZXN0REIuUHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHByb3BzID0gdGVzdERCLlByb3BlcnRpZXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICBleHBlY3QocHJvcHMuRW5naW5lKS50b0JlKCdwb3N0Z3Jlc3FsJyk7XG4gICAgICBleHBlY3QocHJvcHMuREJJbnN0YW5jZUNsYXNzKS50b0JlKCdkYi5yNS5sYXJnZScpO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8g44Ko44Op44O844OP44Oz44OJ44Oq44Oz44Kw44Gu5pyA6YGp5YyW44OG44K544OIXG4gIGl0KCdzaG91bGQgcHJvdmlkZSBvcHRpbWl6ZWQgZXJyb3IgaGFuZGxpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IFRlbXBsYXRlUGFyc2VyKCk7XG4gICAgXG4gICAgLy8gUmVzb3VyY2Vz44K744Kv44K344On44Oz44GM54Sh44GE5aC05ZCIXG4gICAgY29uc3Qgbm9SZXNvdXJjZXNUZW1wbGF0ZSA9IGBcbkFXU1RlbXBsYXRlRm9ybWF0VmVyc2lvbjogJzIwMTAtMDktMDknXG5EZXNjcmlwdGlvbjogJ1RlbXBsYXRlIHdpdGhvdXQgUmVzb3VyY2VzIHNlY3Rpb24nXG5gO1xuICAgIFxuICAgIGNvbnN0IG5vUmVzb3VyY2VzUGF0aCA9IHBhdGguam9pbih0ZW1wRGlyLCAnbm8tcmVzb3VyY2VzLnlhbWwnKTtcbiAgICB3cml0ZUZpbGVTeW5jKG5vUmVzb3VyY2VzUGF0aCwgbm9SZXNvdXJjZXNUZW1wbGF0ZSwgJ3V0ZjgnKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwYXJzZXIucGFyc2Uobm9SZXNvdXJjZXNQYXRoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZXhwZWN0KGVycm9yLnR5cGUpLnRvQmUoJ1BBUlNFX0VSUk9SJyk7XG4gICAgICBleHBlY3QoZXJyb3IubWVzc2FnZSkudG9Db250YWluKCdSZXNvdXJjZXMnKTtcbiAgICAgIGV4cGVjdChlcnJvci5maWxlUGF0aCkudG9CZShub1Jlc291cmNlc1BhdGgpO1xuICAgICAgXG4gICAgICBjb25zdCBzdHJ1Y3R1cmVkID0gZXJyb3IudG9TdHJ1Y3R1cmVkT3V0cHV0KCk7XG4gICAgICBleHBlY3Qoc3RydWN0dXJlZC50aW1lc3RhbXApLnRvQmVEZWZpbmVkKCk7XG4gICAgfVxuICB9KTtcblxuICAvLyDlpKfopo/mqKHjg4bjg7Pjg5fjg6zjg7zjg4jjga7lirnnjofnmoTlh6bnkIZcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgbW9kZXJhdGVseSBsYXJnZSB0ZW1wbGF0ZXMgZWZmaWNpZW50bHknLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcGFyc2VyID0gbmV3IFRlbXBsYXRlUGFyc2VyKCk7XG4gICAgXG4gICAgLy8g5Lit6KaP5qih44OG44Oz44OX44Os44O844OI77yIMTAwMOODquOCveODvOOCueeoi+W6pu+8iVxuICAgIGNvbnN0IG1lZGl1bVRlbXBsYXRlID0ge1xuICAgICAgQVdTVGVtcGxhdGVGb3JtYXRWZXJzaW9uOiBcIjIwMTAtMDktMDlcIixcbiAgICAgIERlc2NyaXB0aW9uOiBcIk1lZGl1bSBzaXplIHRlbXBsYXRlXCIsXG4gICAgICBSZXNvdXJjZXM6IHt9IGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICAgfTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKykge1xuICAgICAgbWVkaXVtVGVtcGxhdGUuUmVzb3VyY2VzW2BUZXN0QnVja2V0JHtpfWBdID0ge1xuICAgICAgICBUeXBlOiBcIkFXUzo6UzM6OkJ1Y2tldFwiLFxuICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgQnVja2V0TmFtZTogYHRlc3QtYnVja2V0LSR7aX1gXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IG1lZGl1bVBhdGggPSBwYXRoLmpvaW4odGVtcERpciwgJ21lZGl1bS10ZW1wbGF0ZS5qc29uJyk7XG4gICAgd3JpdGVGaWxlU3luYyhtZWRpdW1QYXRoLCBKU09OLnN0cmluZ2lmeShtZWRpdW1UZW1wbGF0ZSwgbnVsbCwgMiksICd1dGY4Jyk7XG4gICAgXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCBwYXJzZXIucGFyc2UobWVkaXVtUGF0aCk7XG4gICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICBcbiAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbigyMDAwKTsgLy8gMuenkuS7peWGhVxuICAgIGV4cGVjdChPYmplY3Qua2V5cyh0ZW1wbGF0ZS5SZXNvdXJjZXMpKS50b0hhdmVMZW5ndGgoMTAwMCk7XG4gIH0pO1xuXG4gIC8vIOOCpOODs+OCv+ODvOODleOCp+ODvOOCueWei+WuieWFqOaAp+ODhuOCueODiO+8iENMQVVERS5tZDogSW50ZXJmYWNlIFNlZ3JlZ2F0aW9u77yJXG4gIGl0KCdzaG91bGQgaW1wbGVtZW50IElUZW1wbGF0ZVBhcnNlciBpbnRlcmZhY2UgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIGNvbnN0IHBhcnNlciA9IG5ldyBUZW1wbGF0ZVBhcnNlcigpO1xuICAgIFxuICAgIC8vIOOCpOODs+OCv+ODvOODleOCp+ODvOOCueWun+ijheeiuuiqjVxuICAgIGV4cGVjdCh0eXBlb2YgcGFyc2VyLnBhcnNlKS50b0JlKCdmdW5jdGlvbicpO1xuICAgIGV4cGVjdChwYXJzZXIucGFyc2UubGVuZ3RoKS50b0JlKDEpOyAvLyDlvJXmlbAx5YCLXG4gICAgXG4gICAgLy8gU09MSUQgSW50ZXJmYWNlIFNlZ3JlZ2F0aW9u5Y6f5YmH56K66KqNXG4gICAgLy8gVGVtcGxhdGVQYXJzZXLjga/op6PmnpDjga7jgb/jgavnibnljJZcbiAgICBjb25zdCBwYXJzZXJNZXRob2RzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoT2JqZWN0LmdldFByb3RvdHlwZU9mKHBhcnNlcikpO1xuICAgIGNvbnN0IHB1YmxpY01ldGhvZHMgPSBwYXJzZXJNZXRob2RzLmZpbHRlcihtZXRob2QgPT4gIW1ldGhvZC5zdGFydHNXaXRoKCdfJykgJiYgbWV0aG9kICE9PSAnY29uc3RydWN0b3InKTtcbiAgICBcbiAgICBleHBlY3QocHVibGljTWV0aG9kcykudG9Db250YWluKCdwYXJzZScpO1xuICAgIGV4cGVjdChwdWJsaWNNZXRob2RzLmxlbmd0aCkudG9CZSgxKTsgLy8gcGFyc2Xjg6Hjgr3jg4Pjg4njga7jgb9wdWJsaWNcbiAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=