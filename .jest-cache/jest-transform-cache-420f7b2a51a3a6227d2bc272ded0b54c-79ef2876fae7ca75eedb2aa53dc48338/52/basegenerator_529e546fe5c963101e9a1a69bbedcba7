03c2970a61d1f561c07e343acd79e5c8
"use strict";
// CLAUDE.md準拠BaseMetricsGenerator（SOLID抽象化原則 + Type-Driven Development）
Object.defineProperty(exports, "__esModule", { value: true });
exports.MetricsGenerationMonitor = exports.BaseMetricsGenerator = void 0;
exports.validateMetricDefinition = validateMetricDefinition;
const error_1 = require("../utils/error");
// SOLID原則: 抽象化による拡張性確保（Open/Closed Principle）
class BaseMetricsGenerator {
    logger;
    constructor(logger) {
        this.logger = logger;
    }
    // メイン生成メソッド（CLAUDE.md: Type-Driven Development）
    async generate(resource) {
        const startTime = performance.now();
        try {
            // 型安全なリソース検証
            this.validateResource(resource);
            // 適用可能メトリクス決定
            const applicableConfigs = this.getApplicableMetrics(resource);
            // メトリクス定義生成（型安全性重視）
            const metrics = applicableConfigs.map(config => this.buildMetricDefinition(resource, config));
            const duration = performance.now() - startTime;
            // パフォーマンス監視（CLAUDE.md: 性能要件）
            if (duration > 1000) {
                this.logger.warn(`Metrics generation slow: ${duration.toFixed(0)}ms for ${this.getResourceId(resource)}`);
            }
            else {
                this.logger.debug(`Generated ${metrics.length} metrics for ${this.getResourceId(resource)} in ${duration.toFixed(1)}ms`);
            }
            return metrics;
        }
        catch (error) {
            const resourceId = this.getResourceId(resource);
            this.logger.error(`Failed to generate metrics for ${resourceId}`, error);
            throw (0, error_1.createResourceError)(`Metrics generation failed for ${resourceId}: ${error.message}`, { resourceType: resource.Type, originalError: error.message });
        }
    }
    // 適用可能メトリクス判定（Type-Driven Development）
    getApplicableMetrics(resource) {
        const allConfigs = this.getMetricsConfig(resource);
        return allConfigs.filter(config => {
            if (!config.applicableWhen) {
                return true; // 条件なしは全て適用
            }
            try {
                return config.applicableWhen(resource);
            }
            catch (error) {
                this.logger.warn(`Failed to evaluate metric condition: ${config.name}`, error);
                return false; // 評価失敗時は適用しない
            }
        });
    }
    // メトリクス定義構築（型安全性重視）
    buildMetricDefinition(resource, config) {
        const threshold = this.calculateThreshold(resource, config);
        return {
            metric_name: config.name,
            namespace: config.namespace,
            unit: config.unit,
            description: config.description,
            statistic: config.statistic,
            recommended_threshold: threshold,
            evaluation_period: config.evaluationPeriod,
            category: config.category,
            importance: config.importance,
            dimensions: this.buildDimensions(resource, config)
        };
    }
    // 動的しきい値計算（CLAUDE.md: アルゴリズム実装）
    calculateThreshold(resource, config) {
        // リソーススケール係数取得
        const scale = this.getResourceScale(resource);
        const base = config.threshold.base;
        // 動的計算（CLAUDE.md: Type-Driven Development）
        const warning = Math.round(base * scale * config.threshold.warningMultiplier);
        const critical = Math.round(base * scale * config.threshold.criticalMultiplier);
        // しきい値妥当性検証（warning < critical）
        if (warning >= critical) {
            this.logger.warn(`Invalid threshold calculation: warning=${warning} >= critical=${critical} for ${config.name}`);
            // 自動修正（critical = warning * 1.5）
            const correctedCritical = Math.round(warning * 1.5);
            this.logger.info(`Auto-corrected critical threshold: ${critical} → ${correctedCritical}`);
            return {
                warning,
                critical: correctedCritical
            };
        }
        return { warning, critical };
    }
    // CloudWatchディメンション構築（AWS仕様準拠）
    buildDimensions(resource, _config // 将来拡張用（現在未使用）
    ) {
        const resourceId = this.getResourceId(resource);
        const primaryDimension = this.getPrimaryDimensionName(resource.Type);
        return [
            {
                name: primaryDimension,
                value: resourceId
            }
        ];
    }
    // リソースタイプ別プライマリディメンション（AWS CloudWatch仕様）
    getPrimaryDimensionName(resourceType) {
        const dimensionMap = {
            'AWS::RDS::DBInstance': 'DBInstanceIdentifier',
            'AWS::Lambda::Function': 'FunctionName',
            'AWS::Serverless::Function': 'FunctionName',
            'AWS::ECS::Service': 'ServiceName',
            'AWS::ElasticLoadBalancingV2::LoadBalancer': 'LoadBalancer',
            'AWS::DynamoDB::Table': 'TableName',
            'AWS::ApiGateway::RestApi': 'ApiName',
            'AWS::Serverless::Api': 'ApiName'
        };
        return dimensionMap[resourceType] ?? 'ResourceId';
    }
    // 型安全なリソースID取得
    getResourceId(resource) {
        // LogicalIdプロパティの型安全取得
        const resourceWithId = resource;
        return resourceWithId.LogicalId ?? 'UnknownResource';
    }
    // リソース基本検証（型安全性）
    validateResource(resource) {
        if (!resource.Type || typeof resource.Type !== 'string') {
            throw (0, error_1.createResourceError)('Resource must have a valid Type property', { resourceData: JSON.stringify(resource) });
        }
        if (!this.getSupportedTypes().includes(resource.Type)) {
            throw (0, error_1.createResourceError)(`Unsupported resource type: ${resource.Type}`, {
                resourceType: resource.Type,
                supportedTypes: this.getSupportedTypes()
            });
        }
    }
}
exports.BaseMetricsGenerator = BaseMetricsGenerator;
// パフォーマンス測定ヘルパー（CLAUDE.md: 単一責任分離）
class MetricsGenerationMonitor {
    static async measureGenerationPerformance(generator, resource) {
        const startTime = performance.now();
        const memoryBefore = process.memoryUsage().heapUsed;
        const metrics = await generator.generate(resource);
        const duration = performance.now() - startTime;
        const memoryAfter = process.memoryUsage().heapUsed;
        const memoryDelta = (memoryAfter - memoryBefore) / 1024 / 1024;
        // 統計情報計算
        const stats = {
            resourceType: resource.Type,
            metricsGenerated: metrics.length,
            generationTimeMs: Math.round(duration),
            averageThresholdWarning: metrics.reduce((sum, m) => sum + m.recommended_threshold.warning, 0) / metrics.length,
            averageThresholdCritical: metrics.reduce((sum, m) => sum + m.recommended_threshold.critical, 0) / metrics.length
        };
        // パフォーマンス評価
        let performanceGrade;
        if (duration < 100 && memoryDelta < 1) {
            performanceGrade = 'A'; // 100ms以下、メモリ1MB以下
        }
        else if (duration < 500 && memoryDelta < 5) {
            performanceGrade = 'B'; // 500ms以下、メモリ5MB以下
        }
        else if (duration < 1000 && memoryDelta < 10) {
            performanceGrade = 'C'; // 1秒以下、メモリ10MB以下
        }
        else {
            performanceGrade = 'F'; // 要件超過
        }
        return {
            metrics,
            stats,
            performanceGrade
        };
    }
}
exports.MetricsGenerationMonitor = MetricsGenerationMonitor;
// 型安全なメトリクス検証（CLAUDE.md: Type-Driven Development）
function validateMetricDefinition(metric) {
    const errors = [];
    // 必須フィールド検証
    if (!metric.metric_name || typeof metric.metric_name !== 'string') {
        errors.push('metric_name must be a non-empty string');
    }
    if (!metric.namespace || typeof metric.namespace !== 'string') {
        errors.push('namespace must be a non-empty string');
    }
    // しきい値妥当性検証（カスタムマッチャーと同じロジック）
    const threshold = metric.recommended_threshold;
    if (threshold.warning >= threshold.critical) {
        errors.push(`Invalid threshold: warning(${threshold.warning}) >= critical(${threshold.critical})`);
    }
    if (threshold.warning <= 0 || threshold.critical <= 0) {
        errors.push('Thresholds must be positive numbers');
    }
    // 評価期間検証
    const validPeriods = [60, 300, 900, 3600]; // CloudWatch標準期間
    if (!validPeriods.includes(metric.evaluation_period)) {
        errors.push(`Invalid evaluation_period: ${metric.evaluation_period}. Valid: ${validPeriods.join(', ')}`);
    }
    return {
        isValid: errors.length === 0,
        errors
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvc3JjL2dlbmVyYXRvcnMvYmFzZS5nZW5lcmF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHdFQUF3RTs7O0FBaVB4RSw0REFtQ0M7QUEvUUQsMENBQXFEO0FBRXJELDhDQUE4QztBQUM5QyxNQUFzQixvQkFBb0I7SUFFbEI7SUFBdEIsWUFBc0IsTUFBZTtRQUFmLFdBQU0sR0FBTixNQUFNLENBQVM7SUFBRyxDQUFDO0lBT3pDLGdEQUFnRDtJQUNoRCxLQUFLLENBQUMsUUFBUSxDQUFDLFFBQWdDO1FBQzdDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVwQyxJQUFJLENBQUM7WUFDSCxhQUFhO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRWhDLGNBQWM7WUFDZCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU5RCxvQkFBb0I7WUFDcEIsTUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQzdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQzdDLENBQUM7WUFFRixNQUFNLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBRS9DLDZCQUE2QjtZQUM3QixJQUFJLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDNUcsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsT0FBTyxDQUFDLE1BQU0sZ0JBQWdCLElBQUksQ0FB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QUFDLHFDQUFxQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFNBQVM7SUFDVCxNQUFNLFlBQVksR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsaUJBQWlCO0lBQzVELElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7UUFDckQsTUFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsTUFBTSxDQUFDLGlCQUFpQixZQUFZLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzNHLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQztRQUM1QixNQUFNO0tBQ1AsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUva3lvaGVpL2F3c19jbG91ZF9zdXBwb3J0ZXIvc3JjL2dlbmVyYXRvcnMvYmFzZS5nZW5lcmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ0xBVURFLm1k5rqW5ougQmFzZU1ldHJpY3NHZW5lcmF0b3LvvIhTT0xJROaKveixoeWMluWOn+WJhyArIFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG5cbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UgfSBmcm9tICcuLi90eXBlcy9jbG91ZGZvcm1hdGlvbic7XG5pbXBvcnQgeyBNZXRyaWNEZWZpbml0aW9uLCBNZXRyaWNDb25maWcsIElNZXRyaWNzR2VuZXJhdG9yIH0gZnJvbSAnLi4vdHlwZXMvbWV0cmljcyc7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IGNyZWF0ZVJlc291cmNlRXJyb3IgfSBmcm9tICcuLi91dGlscy9lcnJvcic7XG5cbi8vIFNPTElE5Y6f5YmHOiDmir3osaHljJbjgavjgojjgovmi6HlvLXmgKfnorrkv53vvIhPcGVuL0Nsb3NlZCBQcmluY2lwbGXvvIlcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCYXNlTWV0cmljc0dlbmVyYXRvciBpbXBsZW1lbnRzIElNZXRyaWNzR2VuZXJhdG9yIHtcbiAgXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBsb2dnZXI6IElMb2dnZXIpIHt9XG5cbiAgLy8g5oq96LGh44Oh44K944OD44OJ576k77yIU09MSUQ6IEludGVyZmFjZSBTZWdyZWdhdGlvbu+8iVxuICBhYnN0cmFjdCBnZXRTdXBwb3J0ZWRUeXBlcygpOiBzdHJpbmdbXTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldE1ldHJpY3NDb25maWcocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBNZXRyaWNDb25maWdbXTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldFJlc291cmNlU2NhbGUocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBudW1iZXI7XG5cbiAgLy8g44Oh44Kk44Oz55Sf5oiQ44Oh44K944OD44OJ77yIQ0xBVURFLm1kOiBUeXBlLURyaXZlbiBEZXZlbG9wbWVudO+8iVxuICBhc3luYyBnZW5lcmF0ZShyZXNvdXJjZTogQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSk6IFByb21pc2U8TWV0cmljRGVmaW5pdGlvbltdPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIOWei+WuieWFqOOBquODquOCveODvOOCueaknOiovFxuICAgICAgdGhpcy52YWxpZGF0ZVJlc291cmNlKHJlc291cmNlKTtcbiAgICAgIFxuICAgICAgLy8g6YGp55So5Y+v6IO944Oh44OI44Oq44Kv44K55rG65a6aXG4gICAgICBjb25zdCBhcHBsaWNhYmxlQ29uZmlncyA9IHRoaXMuZ2V0QXBwbGljYWJsZU1ldHJpY3MocmVzb3VyY2UpO1xuICAgICAgXG4gICAgICAvLyDjg6Hjg4jjg6rjgq/jgrnlrprnvqnnlJ/miJDvvIjlnovlronlhajmgKfph43oppbvvIlcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBhcHBsaWNhYmxlQ29uZmlncy5tYXAoY29uZmlnID0+IFxuICAgICAgICB0aGlzLmJ1aWxkTWV0cmljRGVmaW5pdGlvbihyZXNvdXJjZSwgY29uZmlnKVxuICAgICAgKTtcblxuICAgICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIFxuICAgICAgLy8g44OR44OV44Kp44O844Oe44Oz44K555uj6KaW77yIQ0xBVURFLm1kOiDmgKfog73opoHku7bvvIlcbiAgICAgIGlmIChkdXJhdGlvbiA+IDEwMDApIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgTWV0cmljcyBnZW5lcmF0aW9uIHNsb3c6ICR7ZHVyYXRpb24udG9GaXhlZCgwKX1tcyBmb3IgJHt0aGlzLmdldFJlc291cmNlSWQocmVzb3VyY2UpfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoYEdlbmVyYXRlZCAke21ldHJpY3MubGVuZ3RofSBtZXRyaWNzIGZvciAke3RoaXMuZ2V0UmVzb3VyY2VJZChyZXNvdXJjZSl9IGluICR7ZHVyYXRpb24udG9GaXhlZCgxKX1tc2ApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbWV0cmljcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgcmVzb3VyY2VJZCA9IHRoaXMuZ2V0UmVzb3VyY2VJZChyZXNvdXJjZSk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGdlbmVyYXRlIG1ldHJpY3MgZm9yICR7cmVzb3VyY2VJZH1gLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICB0aHJvdyBjcmVhdGVSZXNvdXJjZUVycm9yKFxuICAgICAgICBgTWV0cmljcyBnZW5lcmF0aW9uIGZhaWxlZCBmb3IgJHtyZXNvdXJjZUlkfTogJHsoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2V9YCxcbiAgICAgICAgeyByZXNvdXJjZVR5cGU6IHJlc291cmNlLlR5cGUsIG9yaWdpbmFsRXJyb3I6IChlcnJvciBhcyBFcnJvcikubWVzc2FnZSB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIOmBqeeUqOWPr+iDveODoeODiOODquOCr+OCueWIpOWumu+8iFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG4gIHByaXZhdGUgZ2V0QXBwbGljYWJsZU1ldHJpY3MocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBNZXRyaWNDb25maWdbXSB7XG4gICAgY29uc3QgYWxsQ29uZmlncyA9IHRoaXMuZ2V0TWV0cmljc0NvbmZpZyhyZXNvdXJjZSk7XG4gICAgXG4gICAgcmV0dXJuIGFsbENvbmZpZ3MuZmlsdGVyKGNvbmZpZyA9PiB7XG4gICAgICBpZiAoIWNvbmZpZy5hcHBsaWNhYmxlV2hlbikge1xuICAgICAgICByZXR1cm4gdHJ1ZTsgLy8g5p2h5Lu244Gq44GX44Gv5YWo44Gm6YGp55SoXG4gICAgICB9XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBjb25maWcuYXBwbGljYWJsZVdoZW4ocmVzb3VyY2UpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgRmFpbGVkIHRvIGV2YWx1YXRlIG1ldHJpYyBjb25kaXRpb246ICR7Y29uZmlnLm5hbWV9YCwgZXJyb3IgYXMgRXJyb3IpO1xuICAgICAgICByZXR1cm4gZmFsc2U7IC8vIOipleS+oeWkseaVl+aZguOBr+mBqeeUqOOBl+OBquOBhFxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8g44Oh44OI44Oq44Kv44K55a6a576p5qeL56+J77yI5Z6L5a6J5YWo5oCn6YeN6KaW77yJXG4gIHByaXZhdGUgYnVpbGRNZXRyaWNEZWZpbml0aW9uKFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlLFxuICAgIGNvbmZpZzogTWV0cmljQ29uZmlnXG4gICk6IE1ldHJpY0RlZmluaXRpb24ge1xuICAgIGNvbnN0IHRocmVzaG9sZCA9IHRoaXMuY2FsY3VsYXRlVGhyZXNob2xkKHJlc291cmNlLCBjb25maWcpO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBtZXRyaWNfbmFtZTogY29uZmlnLm5hbWUsXG4gICAgICBuYW1lc3BhY2U6IGNvbmZpZy5uYW1lc3BhY2UsXG4gICAgICB1bml0OiBjb25maWcudW5pdCxcbiAgICAgIGRlc2NyaXB0aW9uOiBjb25maWcuZGVzY3JpcHRpb24sXG4gICAgICBzdGF0aXN0aWM6IGNvbmZpZy5zdGF0aXN0aWMsXG4gICAgICByZWNvbW1lbmRlZF90aHJlc2hvbGQ6IHRocmVzaG9sZCxcbiAgICAgIGV2YWx1YXRpb25fcGVyaW9kOiBjb25maWcuZXZhbHVhdGlvblBlcmlvZCxcbiAgICAgIGNhdGVnb3J5OiBjb25maWcuY2F0ZWdvcnksXG4gICAgICBpbXBvcnRhbmNlOiBjb25maWcuaW1wb3J0YW5jZSxcbiAgICAgIGRpbWVuc2lvbnM6IHRoaXMuYnVpbGREaW1lbnNpb25zKHJlc291cmNlLCBjb25maWcpXG4gICAgfTtcbiAgfVxuXG4gIC8vIOWLleeahOOBl+OBjeOBhOWApOioiOeul++8iENMQVVERS5tZDog44Ki44Or44K044Oq44K644Og5a6f6KOF77yJXG4gIHByaXZhdGUgY2FsY3VsYXRlVGhyZXNob2xkKFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlLFxuICAgIGNvbmZpZzogTWV0cmljQ29uZmlnXG4gICk6IHsgd2FybmluZzogbnVtYmVyOyBjcml0aWNhbDogbnVtYmVyIH0ge1xuICAgIC8vIOODquOCveODvOOCueOCueOCseODvOODq+S/guaVsOWPluW+l1xuICAgIGNvbnN0IHNjYWxlID0gdGhpcy5nZXRSZXNvdXJjZVNjYWxlKHJlc291cmNlKTtcbiAgICBjb25zdCBiYXNlID0gY29uZmlnLnRocmVzaG9sZC5iYXNlO1xuICAgIFxuICAgIC8vIOWLleeahOioiOeul++8iENMQVVERS5tZDogVHlwZS1Ecml2ZW4gRGV2ZWxvcG1lbnTvvIlcbiAgICBjb25zdCB3YXJuaW5nID0gTWF0aC5yb3VuZChiYXNlICogc2NhbGUgKiBjb25maWcudGhyZXNob2xkLndhcm5pbmdNdWx0aXBsaWVyKTtcbiAgICBjb25zdCBjcml0aWNhbCA9IE1hdGgucm91bmQoYmFzZSAqIHNjYWxlICogY29uZmlnLnRocmVzaG9sZC5jcml0aWNhbE11bHRpcGxpZXIpO1xuICAgIFxuICAgIC8vIOOBl+OBjeOBhOWApOWmpeW9k+aAp+aknOiovO+8iHdhcm5pbmcgPCBjcml0aWNhbO+8iVxuICAgIGlmICh3YXJuaW5nID49IGNyaXRpY2FsKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBJbnZhbGlkIHRocmVzaG9sZCBjYWxjdWxhdGlvbjogd2FybmluZz0ke3dhcm5pbmd9ID49IGNyaXRpY2FsPSR7Y3JpdGljYWx9IGZvciAke2NvbmZpZy5uYW1lfWApO1xuICAgICAgXG4gICAgICAvLyDoh6rli5Xkv67mraPvvIhjcml0aWNhbCA9IHdhcm5pbmcgKiAxLjXvvIlcbiAgICAgIGNvbnN0IGNvcnJlY3RlZENyaXRpY2FsID0gTWF0aC5yb3VuZCh3YXJuaW5nICogMS41KTtcbiAgICAgIHRoaXMubG9nZ2VyLmluZm8oYEF1dG8tY29ycmVjdGVkIGNyaXRpY2FsIHRocmVzaG9sZDogJHtjcml0aWNhbH0g4oaSICR7Y29ycmVjdGVkQ3JpdGljYWx9YCk7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHdhcm5pbmcsXG4gICAgICAgIGNyaXRpY2FsOiBjb3JyZWN0ZWRDcml0aWNhbFxuICAgICAgfTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHsgd2FybmluZywgY3JpdGljYWwgfTtcbiAgfVxuXG4gIC8vIENsb3VkV2F0Y2jjg4fjgqPjg6Hjg7Pjgrfjg6fjg7Pmp4vnr4nvvIhBV1Pku5Xmp5jmupbmi6DvvIlcbiAgcHJpdmF0ZSBidWlsZERpbWVuc2lvbnMoXG4gICAgcmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UsXG4gICAgX2NvbmZpZzogTWV0cmljQ29uZmlnIC8vIOWwhuadpeaLoeW8teeUqO+8iOePvuWcqOacquS9v+eUqO+8iVxuICApOiBBcnJheTx7IG5hbWU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgcmVzb3VyY2VJZCA9IHRoaXMuZ2V0UmVzb3VyY2VJZChyZXNvdXJjZSk7XG4gICAgY29uc3QgcHJpbWFyeURpbWVuc2lvbiA9IHRoaXMuZ2V0UHJpbWFyeURpbWVuc2lvbk5hbWUocmVzb3VyY2UuVHlwZSk7XG4gICAgXG4gICAgcmV0dXJuIFtcbiAgICAgIHtcbiAgICAgICAgbmFtZTogcHJpbWFyeURpbWVuc2lvbixcbiAgICAgICAgdmFsdWU6IHJlc291cmNlSWRcbiAgICAgIH1cbiAgICBdO1xuICB9XG5cbiAgLy8g44Oq44K944O844K544K/44Kk44OX5Yil44OX44Op44Kk44Oe44Oq44OH44Kj44Oh44Oz44K344On44Oz77yIQVdTIENsb3VkV2F0Y2jku5Xmp5jvvIlcbiAgcHJpdmF0ZSBnZXRQcmltYXJ5RGltZW5zaW9uTmFtZShyZXNvdXJjZVR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZGltZW5zaW9uTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgJ0FXUzo6UkRTOjpEQkluc3RhbmNlJzogJ0RCSW5zdGFuY2VJZGVudGlmaWVyJyxcbiAgICAgICdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nOiAnRnVuY3Rpb25OYW1lJyxcbiAgICAgICdBV1M6OlNlcnZlcmxlc3M6OkZ1bmN0aW9uJzogJ0Z1bmN0aW9uTmFtZScsXG4gICAgICAnQVdTOjpFQ1M6OlNlcnZpY2UnOiAnU2VydmljZU5hbWUnLFxuICAgICAgJ0FXUzo6RWxhc3RpY0xvYWRCYWxhbmNpbmdWMjo6TG9hZEJhbGFuY2VyJzogJ0xvYWRCYWxhbmNlcicsXG4gICAgICAnQVdTOjpEeW5hbW9EQjo6VGFibGUnOiAnVGFibGVOYW1lJyxcbiAgICAgICdBV1M6OkFwaUdhdGV3YXk6OlJlc3RBcGknOiAnQXBpTmFtZScsXG4gICAgICAnQVdTOjpTZXJ2ZXJsZXNzOjpBcGknOiAnQXBpTmFtZSdcbiAgICB9O1xuICAgIFxuICAgIHJldHVybiBkaW1lbnNpb25NYXBbcmVzb3VyY2VUeXBlXSA/PyAnUmVzb3VyY2VJZCc7XG4gIH1cblxuICAvLyDlnovlronlhajjgarjg6rjgr3jg7zjgrlJROWPluW+l1xuICBwcml2YXRlIGdldFJlc291cmNlSWQocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiBzdHJpbmcge1xuICAgIC8vIExvZ2ljYWxJZOODl+ODreODkeODhuOCo+OBruWei+WuieWFqOWPluW+l1xuICAgIGNvbnN0IHJlc291cmNlV2l0aElkID0gcmVzb3VyY2UgYXMgQ2xvdWRGb3JtYXRpb25SZXNvdXJjZSAmIHsgTG9naWNhbElkPzogc3RyaW5nIH07XG4gICAgcmV0dXJuIHJlc291cmNlV2l0aElkLkxvZ2ljYWxJZCA/PyAnVW5rbm93blJlc291cmNlJztcbiAgfVxuXG4gIC8vIOODquOCveODvOOCueWfuuacrOaknOiovO+8iOWei+WuieWFqOaAp++8iVxuICBwcml2YXRlIHZhbGlkYXRlUmVzb3VyY2UocmVzb3VyY2U6IENsb3VkRm9ybWF0aW9uUmVzb3VyY2UpOiB2b2lkIHtcbiAgICBpZiAoIXJlc291cmNlLlR5cGUgfHwgdHlwZW9mIHJlc291cmNlLlR5cGUgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBjcmVhdGVSZXNvdXJjZUVycm9yKFxuICAgICAgICAnUmVzb3VyY2UgbXVzdCBoYXZlIGEgdmFsaWQgVHlwZSBwcm9wZXJ0eScsXG4gICAgICAgIHsgcmVzb3VyY2VEYXRhOiBKU09OLnN0cmluZ2lmeShyZXNvdXJjZSkgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZ2V0U3VwcG9ydGVkVHlwZXMoKS5pbmNsdWRlcyhyZXNvdXJjZS5UeXBlKSkge1xuICAgICAgdGhyb3cgY3JlYXRlUmVzb3VyY2VFcnJvcihcbiAgICAgICAgYFVuc3VwcG9ydGVkIHJlc291cmNlIHR5cGU6ICR7cmVzb3VyY2UuVHlwZX1gLFxuICAgICAgICB7IFxuICAgICAgICAgIHJlc291cmNlVHlwZTogcmVzb3VyY2UuVHlwZSxcbiAgICAgICAgICBzdXBwb3J0ZWRUeXBlczogdGhpcy5nZXRTdXBwb3J0ZWRUeXBlcygpXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbi8vIOODoeODiOODquOCr+OCueeUn+aIkOe1seioiOaDheWgse+8iENMQVVERS5tZDog55uj6KaW44O744OH44OQ44OD44Kw5pSv5o+077yJXG5leHBvcnQgaW50ZXJmYWNlIEdlbmVyYXRpb25TdGF0cyB7XG4gIHJlc291cmNlVHlwZTogc3RyaW5nO1xuICBtZXRyaWNzR2VuZXJhdGVkOiBudW1iZXI7XG4gIGdlbmVyYXRpb25UaW1lTXM6IG51bWJlcjtcbiAgYXZlcmFnZVRocmVzaG9sZFdhcm5pbmc6IG51bWJlcjtcbiAgYXZlcmFnZVRocmVzaG9sZENyaXRpY2FsOiBudW1iZXI7XG59XG5cbi8vIOODkeODleOCqeODvOODnuODs+OCuea4rOWumuODmOODq+ODkeODvO+8iENMQVVERS5tZDog5Y2Y5LiA6LKs5Lu75YiG6Zui77yJXG5leHBvcnQgY2xhc3MgTWV0cmljc0dlbmVyYXRpb25Nb25pdG9yIHtcbiAgXG4gIHN0YXRpYyBhc3luYyBtZWFzdXJlR2VuZXJhdGlvblBlcmZvcm1hbmNlPFQgZXh0ZW5kcyBCYXNlTWV0cmljc0dlbmVyYXRvcj4oXG4gICAgZ2VuZXJhdG9yOiBULFxuICAgIHJlc291cmNlOiBDbG91ZEZvcm1hdGlvblJlc291cmNlXG4gICk6IFByb21pc2U8e1xuICAgIG1ldHJpY3M6IE1ldHJpY0RlZmluaXRpb25bXTtcbiAgICBzdGF0czogR2VuZXJhdGlvblN0YXRzO1xuICAgIHBlcmZvcm1hbmNlR3JhZGU6ICdBJyB8ICdCJyB8ICdDJyB8ICdGJztcbiAgfT4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIGNvbnN0IG1lbW9yeUJlZm9yZSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcbiAgICBcbiAgICBjb25zdCBtZXRyaWNzID0gYXdhaXQgZ2VuZXJhdG9yLmdlbmVyYXRlKHJlc291cmNlKTtcbiAgICBcbiAgICBjb25zdCBkdXJhdGlvbiA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIGNvbnN0IG1lbW9yeUFmdGVyID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgIGNvbnN0IG1lbW9yeURlbHRhID0gKG1lbW9yeUFmdGVyIC0gbWVtb3J5QmVmb3JlKSAvIDEwMjQgLyAxMDI0O1xuXG4gICAgLy8g57Wx6KiI5oOF5aCx6KiI566XXG4gICAgY29uc3Qgc3RhdHM6IEdlbmVyYXRpb25TdGF0cyA9IHtcbiAgICAgIHJlc291cmNlVHlwZTogcmVzb3VyY2UuVHlwZSxcbiAgICAgIG1ldHJpY3NHZW5lcmF0ZWQ6IG1ldHJpY3MubGVuZ3RoLFxuICAgICAgZ2VuZXJhdGlvblRpbWVNczogTWF0aC5yb3VuZChkdXJhdGlvbiksXG4gICAgICBhdmVyYWdlVGhyZXNob2xkV2FybmluZzogbWV0cmljcy5yZWR1Y2UoKHN1bSwgbSkgPT4gc3VtICsgbS5yZWNvbW1lbmRlZF90aHJlc2hvbGQud2FybmluZywgMCkgLyBtZXRyaWNzLmxlbmd0aCxcbiAgICAgIGF2ZXJhZ2VUaHJlc2hvbGRDcml0aWNhbDogbWV0cmljcy5yZWR1Y2UoKHN1bSwgbSkgPT4gc3VtICsgbS5yZWNvbW1lbmRlZF90aHJlc2hvbGQuY3JpdGljYWwsIDApIC8gbWV0cmljcy5sZW5ndGhcbiAgICB9O1xuXG4gICAgLy8g44OR44OV44Kp44O844Oe44Oz44K56KmV5L6hXG4gICAgbGV0IHBlcmZvcm1hbmNlR3JhZGU6ICdBJyB8ICdCJyB8ICdDJyB8ICdGJztcbiAgICBpZiAoZHVyYXRpb24gPCAxMDAgJiYgbWVtb3J5RGVsdGEgPCAxKSB7XG4gICAgICBwZXJmb3JtYW5jZUdyYWRlID0gJ0EnOyAvLyAxMDBtc+S7peS4i+OAgeODoeODouODqjFNQuS7peS4i1xuICAgIH0gZWxzZSBpZiAoZHVyYXRpb24gPCA1MDAgJiYgbWVtb3J5RGVsdGEgPCA1KSB7XG4gICAgICBwZXJmb3JtYW5jZUdyYWRlID0gJ0InOyAvLyA1MDBtc+S7peS4i+OAgeODoeODouODqjVNQuS7peS4i1xuICAgIH0gZWxzZSBpZiAoZHVyYXRpb24gPCAxMDAwICYmIG1lbW9yeURlbHRhIDwgMTApIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnQyc7IC8vIDHnp5Lku6XkuIvjgIHjg6Hjg6Ljg6oxME1C5Lul5LiLXG4gICAgfSBlbHNlIHtcbiAgICAgIHBlcmZvcm1hbmNlR3JhZGUgPSAnRic7IC8vIOimgeS7tui2hemBjlxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBtZXRyaWNzLFxuICAgICAgc3RhdHMsXG4gICAgICBwZXJmb3JtYW5jZUdyYWRlXG4gICAgfTtcbiAgfVxufVxuXG4vLyDlnovlronlhajjgarjg6Hjg4jjg6rjgq/jgrnmpJzoqLzvvIhDTEFVREUubWQ6IFR5cGUtRHJpdmVuIERldmVsb3BtZW5077yJXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVNZXRyaWNEZWZpbml0aW9uKG1ldHJpYzogTWV0cmljRGVmaW5pdGlvbik6IHtcbiAgaXNWYWxpZDogYm9vbGVhbjtcbiAgZXJyb3JzOiBzdHJpbmdbXTtcbn0ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgLy8g5b+F6aCI44OV44Kj44O844Or44OJ5qSc6Ki8XG4gIGlmICghbWV0cmljLm1ldHJpY19uYW1lIHx8IHR5cGVvZiBtZXRyaWMubWV0cmljX25hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgZXJyb3JzLnB1c2goJ21ldHJpY19uYW1lIG11c3QgYmUgYSBub24tZW1wdHkgc3RyaW5nJyk7XG4gIH1cbiAgXG4gIGlmICghbWV0cmljLm5hbWVzcGFjZSB8fCB0eXBlb2YgbWV0cmljLm5hbWVzcGFjZSAhPT0gJ3N0cmluZycpIHtcbiAgICBlcnJvcnMucHVzaCgnbmFtZXNwYWNlIG11c3QgYmUgYSBub24tZW1wdHkgc3RyaW5nJyk7XG4gIH1cblxuICAvLyDjgZfjgY3jgYTlgKTlpqXlvZPmgKfmpJzoqLzvvIjjgqvjgrnjgr/jg6Djg57jg4Pjg4Hjg6Pjg7zjgajlkIzjgZjjg63jgrjjg4Pjgq/vvIlcbiAgY29uc3QgdGhyZXNob2xkID0gbWV0cmljLnJlY29tbWVuZGVkX3RocmVzaG9sZDtcbiAgaWYgKHRocmVzaG9sZC53YXJuaW5nID49IHRocmVzaG9sZC5jcml0aWNhbCkge1xuICAgIGVycm9ycy5wdXNoKGBJbnZhbGlkIHRocmVzaG9sZDogd2FybmluZygke3RocmVzaG9sZC53YXJuaW5nfSkgPj0gY3JpdGljYWwoJHt0aHJlc2hvbGQuY3JpdGljYWx9KWApO1xuICB9XG5cbiAgaWYgKHRocmVzaG9sZC53YXJuaW5nIDw9IDAgfHwgdGhyZXNob2xkLmNyaXRpY2FsIDw9IDApIHtcbiAgICBlcnJvcnMucHVzaCgnVGhyZXNob2xkcyBtdXN0IGJlIHBvc2l0aXZlIG51bWJlcnMnKTtcbiAgfVxuXG4gIC8vIOipleS+oeacn+mWk+aknOiovFxuICBjb25zdCB2YWxpZFBlcmlvZHMgPSBbNjAsIDMwMCwgOTAwLCAzNjAwXTsgLy8gQ2xvdWRXYXRjaOaomea6luacn+mWk1xuICBpZiAoIXZhbGlkUGVyaW9kcy5pbmNsdWRlcyhtZXRyaWMuZXZhbHVhdGlvbl9wZXJpb2QpKSB7XG4gICAgZXJyb3JzLnB1c2goYEludmFsaWQgZXZhbHVhdGlvbl9wZXJpb2Q6ICR7bWV0cmljLmV2YWx1YXRpb25fcGVyaW9kfS4gVmFsaWQ6ICR7dmFsaWRQZXJpb2RzLmpvaW4oJywgJyl9YCk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGlzVmFsaWQ6IGVycm9ycy5sZW5ndGggPT09IDAsXG4gICAgZXJyb3JzXG4gIH07XG59Il0sInZlcnNpb24iOjN9